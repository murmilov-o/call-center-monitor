<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–≥</title>
  
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìû</text></svg>">

  <style>
    /* --- 1. GLOBAL RESET --- */
    * { box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px; padding-bottom: 90px; margin: 0;
      background: #f2f2f2; color: #333;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    body.dark { background: #1e1e1e; color: #ddd; }
    .hidden { display: none !important; }
    
    /* ANIMATIONS */
    @keyframes pulse-red { 
        0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 
        70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); } 
        100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } 
    }

    /* --- STATUS COLORS --- */
    /* 1. GREEN (1-5) */
    .status-green { 
        background-color: #e8f5e9 !important; 
        border-left: 6px solid #2ecc71 !important; 
        color: #1b5e20 !important;
    }
    body.dark .status-green { background-color: #1e3a23 !important; color: #c8e6c9 !important; }

    /* 2. ORANGE (6-10) */
    .status-orange { 
        background-color: #fff3cd !important; 
        border-left: 6px solid #f39c12 !important; 
        color: #856404 !important; 
    }
    body.dark .status-orange { background-color: #4e3e20 !important; color: #ffda6a !important; }

    /* 3. RED (>10) */
    .status-red { 
        background-color: #e74c3c !important; 
        color: white !important; 
        border-left: 6px solid #c0392b !important; 
        animation: pulse-red 1.5s infinite;
    }
    .status-red .queue-id, .status-red .local-stats-block, .status-red .queue-info-block { 
        color: rgba(255,255,255,0.9) !important; 
        border-color: rgba(255,255,255,0.3) !important;
    }
    .status-red .badge { background: white; color: #c0392b; }
    
    /* --- COMPONENTS --- */
    .btn {
      cursor: pointer; font-size: 15px; background: #fff; border: 1px solid #ccc;
      padding: 6px 14px; border-radius: 6px; transition: 0.2s; 
      display: inline-flex; align-items: center; justify-content: center; color: #333;
    }
    .btn:hover { background-color: #e9e9e9; }
    .btn.active { background-color: #d4edda; border-color: #28a745; color: #155724; }
    .btn.primary { background-color: #007bff; color: white; border-color: #007bff; }
    
    body.dark .btn { background: #444; border-color: #666; color: #eee; }
    body.dark .btn.active { background-color: #235d3a; border-color: #28a745; color: #fff; }

    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    h1 { margin: 0; font-size: 24px; white-space: nowrap; }
    #status { margin-bottom: 20px; font-size: 14px; color: #666; }
    body.dark #status { color: #aaa; }
    .controls { display: flex; gap: 8px; }

    /* GRID */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; width: 100%; }
    .card {
      background: white; /* Default 0 calls */
      border-radius: 12px; padding: 20px 22px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column;
      justify-content: space-between; transition: all 0.3s ease; min-height: 250px;
      border-left: 6px solid #ccc; 
    }
    body.dark .card { background: #2e2e2e; color: #eee; border-color: #555; }
    .card.dragging { opacity: 0.4; border: 2px dashed #999; }
    
    .queue-name { font-weight: bold; font-size: 18px; margin-bottom: 4px; pointer-events: none; }
    .queue-id { font-size: 13px; color: #565656; margin-bottom: 10px; pointer-events: none; }
    body.dark .queue-id { color: #aaa; }
    .queue-count { font-size: 40px; font-weight: bold; margin-bottom: 10px; pointer-events: none; }
    
    .local-stats-block { font-size: 11px; color: #666; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; }
    body.dark .local-stats-block { color: #aaa; border-color: rgba(255,255,255,0.1); }

    /* LIST */
    .list-container { width: 100%; overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    body.dark .list-container { background: #2e2e2e; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th { text-align: left; padding: 12px 15px; border-bottom: 2px solid #ddd; font-size: 14px; color: #555; background-color: #f8f8f8; }
    body.dark th { border-color: #444; color: #aaa; background-color: #333; }
    td { padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 15px; }
    body.dark td { border-color: #444; }
    
    .queue-row { cursor: pointer; transition: background 0.1s; border-left: 6px solid transparent; }
    .queue-row:hover { background-color: #f0f0f0; }
    body.dark .queue-row:hover { background-color: #383838; }
    
    .detail-row { display: none; background-color: #fafafa; }
    body.dark .detail-row { background-color: #252525; }
    .detail-row.open { display: table-row; }
    .detail-content { padding: 15px; max-height: 300px; overflow-y: auto; border-bottom: 1px solid #ddd; }
    .badge { padding: 4px 10px; border-radius: 6px; font-weight: bold; font-size: 14px; background: #eee; color: #333;}
    body.dark .badge { background: #444; color: #ddd; }

    /* CALLERS */
    .callers-list { font-size: 14px; line-height: 1.6; flex-grow: 1; margin: 6px 0 8px 0; }
    .caller-row { display: flex; align-items: center; margin-bottom: 5px; border-bottom: 1px dotted #ccc; padding-bottom: 2px;}
    .caller-index { margin-right: 8px; font-weight: bold; opacity: 0.7; min-width: 20px; }
    .caller-info { white-space: normal; overflow: visible; flex-grow: 1; margin: 0 5px; }
    .action-btn { cursor: pointer; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; transition: 0.2s; font-size: 16px; margin: 0 2px; }
    .action-btn:hover { background-color: rgba(0,0,0,0.1); transform: scale(1.1); }
    .accept-btn { color: #28a745; } 
    .status-red .accept-btn { color: #fff; background: rgba(255,255,255,0.2); }

    /* TOOLTIPS & GLOBAL BAR */
    .stat-container { position: relative; display: inline-block; cursor: help; }
    .stat-tooltip {
        visibility: hidden; width: 120px; background-color: rgba(0,0,0,0.9); color: #fff; text-align: left;
        border-radius: 6px; padding: 8px; position: absolute; z-index: 9999;
        bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: 0.3s;
        font-size: 11px; pointer-events: none;
    }
    .stat-tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: rgba(0,0,0,0.9) transparent transparent transparent; }
    .stat-container:hover .stat-tooltip { visibility: visible; opacity: 1; }

    .global-stats {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: #2c3e50; color: white;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 2000;
        display: flex; justify-content: center; align-items: center;
        padding: 10px 0; font-size: 14px; gap: 30px;
        min-height: 70px; transition: 0.3s;
    }
    body.dark .global-stats { background: #252525; border-top: 1px solid #444; }
    .global-stats.minimized { transform: translateY(100%); }
    .stats-toggle-tab {
        position: absolute; top: -24px; right: 20px;
        background: #2c3e50; color: white; padding: 2px 15px;
        border-radius: 8px 8px 0 0; cursor: pointer; font-size: 12px; z-index: 2001;
    }
    body.dark .stats-toggle-tab { background: #252525; border: 1px solid #444; border-bottom: none; }
    
    .g-stat-item { text-align: center; min-width: 100px; border-right: 1px solid rgba(255,255,255,0.1); padding-right: 20px; display: flex; flex-direction: column; justify-content: center; }
    .g-stat-item:last-child { border: none; }
    .g-stat-label { display: block; font-size: 10px; opacity: 0.7; text-transform: uppercase; margin-bottom: 5px; }
    .g-stat-value { display: block; font-size: 20px; font-weight: bold; line-height: 1; }
    .g-stat-sub { font-size: 11px; opacity: 0.8; margin-top: 2px; }
    .top-list { font-size: 12px; text-align: left; display: inline-block; }
    .top-count { color: #ff6b6b; font-weight: bold; margin-right: 5px; }

    /* MODAL */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 3000; }
    .modal-content { background: white; padding: 20px; border-radius: 12px; width: 400px; max-height: 85vh; overflow-y: auto; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
    body.dark .modal-content { background: #2b2b2b; color: #eee; }
    .settings-group { margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 15px; }
    body.dark .settings-group { border-color: #444; }
    input[type="text"], select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; background: #fff; color: #000; margin-top: 5px; }
    body.dark input[type="text"], body.dark select { background: #3a3a3a; border-color: #666; color: #eee; }
    .add-queue-form { display: flex; gap: 8px; margin-top: 5px; }
    .delete-q-btn { background: none; border: none; color: #ff4444; cursor: pointer; font-size: 16px; transition: 0.2s; }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

    /* HISTORY STYLES */
    .history-date-row { 
        padding: 12px; background: #f8f9fa; border-bottom: 1px solid #eee; 
        cursor: pointer; font-weight: bold; display: flex; justify-content: space-between;
    }
    .history-date-row:hover { background: #e9ecef; }
    body.dark .history-date-row { background: #333; border-color: #444; }
    body.dark .history-date-row:hover { background: #444; }
    .history-details { display: none; padding: 10px; background: #fff; }
    body.dark .history-details { background: #2b2b2b; }
    .history-details.open { display: block; }
    .h-table { width: 100%; font-size: 13px; border-collapse: collapse; }
    .h-table th, .h-table td { padding: 6px; border-bottom: 1px solid #eee; text-align: left; }
    body.dark .h-table th, body.dark .h-table td { border-color: #444; }

    /* CHEATSHEET */
    .cheatsheet { margin-top: 30px; padding: 20px; border-radius: 12px; background: #fff; display: flex; flex-wrap: wrap; gap: 40px; margin-bottom: 100px; }
    body.dark .cheatsheet { background: #2e2e2e; color: #eee; }
    .cheatsheet h3 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    body.dark .cheatsheet h3 { border-color: #444; }
    .cheatsheet ul { list-style: none; padding: 0; margin: 0; }
    .cheatsheet li { margin: 4px 0; font-size: 14px; }
  </style>
</head>
<body>

<div class="top-bar">
  <h1>üìû –ê–∫—Ç–∏–≤–Ω—ñ —á–µ—Ä–≥–∏</h1>
  <div class="controls">
      <button class="btn active" id="viewGridBtn" onclick="switchView('grid')" title="Grid View">üî≤</button>
      <button class="btn" id="viewListBtn" onclick="switchView('list')" title="List View">‚ò∞</button>
      <button class="btn" id="dragBtn" onclick="toggleDragMode()" title="Drag & Drop">üîí</button>
      
      <button class="btn" onclick="openHistory()" title="History">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      <button class="btn" onclick="openSettings()" title="Settings">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
  </div>
</div>

<div id="status">üîÑ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>

<div class="grid" id="queuesGrid"></div>

<div class="list-container hidden" id="queuesList">
  <table>
    <thead>
      <tr>
        <th style="width: 30%">Queue Name</th>
        <th style="width: 15%">Max Wait</th>
        <th style="width: 10%">Waiting</th>
        <th style="width: 20%">Agents</th>
        <th style="width: 25%">Daily Stats</th>
      </tr>
    </thead>
    <tbody id="listBody"></tbody>
  </table>
</div>

<div class="global-stats" id="statsBar">
    <div class="stats-toggle-tab" onclick="toggleStatsBar()" id="statsToggleIcon">‚ñº –°—Ö–æ–≤–∞—Ç–∏</div>
    
    <div class="g-stat-item">
        <span class="g-stat-label">Total Waiting</span>
        <span class="g-stat-value" id="gs-waiting">0</span>
    </div>
    
    <div class="g-stat-item">
        <span class="g-stat-label">üî• Top 3 Busy</span>
        <div id="gs-top3" class="top-list">
            <div style="opacity:0.5; margin-top:5px;">‚Äî No Calls ‚Äî</div>
        </div>
    </div>

    <div class="g-stat-item">
        <span class="g-stat-label">Max Wait</span>
        <span class="g-stat-value" id="gs-max-hold">00:00</span>
    </div>
    
    <div class="g-stat-item" style="min-width: 180px;">
        <span class="g-stat-label">Total Answered</span>
        <div class="stat-container">
            <div class="g-stat-value" id="gs-today-ans" style="color: #2ecc71;">0</div>
            <div class="stat-tooltip" id="tip-g-ans">Loading...</div>
        </div>
    </div>
</div>

<div class="modal" id="historyModal">
  <div class="modal-content" style="width: 500px;">
    <h2>üìä –Ü—Å—Ç–æ—Ä—ñ—è –¥–∑–≤—ñ–Ω–∫—ñ–≤</h2>
    <div id="historyContent">Loading...</div>
    <div class="modal-buttons">
      <button type="button" class="btn" onclick="closeHistory()">Close</button>
    </div>
  </div>
</div>

<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <form id="settingsForm"></form>
    <div class="modal-buttons">
      <button type="button" class="btn" onclick="closeSettings()">Cancel</button>
      <button type="button" class="btn primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<div class="cheatsheet">
  <div>
    <h3>üìå Prefixes | Call numbers</h3>
    <ul>
      <li>TrackEnsure Support: <strong>04</strong> +1(916)860-1234</li>
      <li>Alfa Support: <strong>06</strong> +1(469)445-27-57</li>
      <li>Vista Support: <strong>09</strong> +1(614)362-22-23 </li>
      <li>Swift Support: <strong>08</strong> +1(678)387-51-75</li>
      <li>Sharp Support: <strong>03</strong> +1(862)208-38-48</li>
      <li>Club Support: <strong>02</strong> +1(615)900-55-51 </li>
      <li>Pro-TracKing Support: <strong>11</strong> +1(623)887-44-22</li>
      <li>Smart eLog Support: <strong>13</strong> +1(916)740-66-74</li>
      <li>KGZ: <strong>12</strong> +1(217)401-12-22</li>
    </ul>
  </div>
  <div>
    <h3>üíº Sales</h3>
    <ul>
      <li>TrackEnsure Sales: <strong>704</strong></li>
      <li>Alfa Sales: <strong>725</strong></li>
      <li>Vista Sales: <strong>726</strong></li>
      <li>Swift Sales: <strong>728</strong></li>
      <li>Sharp Sales: <strong>755</strong></li>
      <li>Club Sales: <strong>746</strong></li>
      <li>Pro-TracKing Sales: <strong>782</strong></li>
      <li>Smart eLog Sales: <strong>812</strong></li>
    </ul>
  </div>
</div>

<script>
  const API_URL = "https://queue-server-fbi5.onrender.com/stats"; 
  const HISTORY_URL = "https://queue-server-fbi5.onrender.com/history";

  const defaultQueueNames = {
    Q700: "TrackEnsure Support", Q701: "TrackEnsure Support rus/ukr", Q801: "Callback rus/ukr", Q800: "Callback",
    Q791: "TrackEnsure New", Q750: "VIP Queue", Q702: "Fleet Supp", Q710: "Alfa Support",
    Q733: "Alfa VIP", Q720: "Vista Support", Q734: "Vista VIP", Q740: "Swift Support",
    Q760: "Swift VIP", Q766: "Sharp Support", Q745: "Club Support", Q781: "Pro-TracKing Support",
    Q730: "Smart eLog Support", Q777: "KGZ",
    Q910: "Alfa Support ru/ukr", Q911: "Alfa Fleet Supp",
    Q940: "Swift Support ru/ukr", Q941: "Swift Fleet Supp"
  };

  let currentView = localStorage.getItem('viewMode') || 'grid';
  let isDragEnabled = false;
  
  const queueCallers = {}; 
  const queuesData = {};   
  const timers = {};       
  
  let fullStats = { daily: { queues: {} }, queuesPeriods: {}, globalPeriods: { h1:{}, h2:{}, h4:{} } };

  const statusEl = document.getElementById('status');
  const gridEl = document.getElementById('queuesGrid');
  const listEl = document.getElementById('queuesList');
  const listBody = document.getElementById('listBody');
  const settingsModal = document.getElementById('settingsModal');
  const settingsForm = document.getElementById('settingsForm');
  const historyModal = document.getElementById('historyModal');
  const historyContent = document.getElementById('historyContent');
  const dragBtn = document.getElementById('dragBtn');

  function getLang() { return localStorage.getItem('lang') || 'ua'; }
  function getTheme() { return localStorage.getItem('theme') || 'light'; }
  function getUserExt() { return localStorage.getItem('userExt') || ''; }
  function getCustomQueues() { return JSON.parse(localStorage.getItem('customQueues') || '{}'); }
  function getAllQueues() { return { ...defaultQueueNames, ...getCustomQueues() }; }
  
  function loadVisibleQueues() { 
      const raw = localStorage.getItem('visibleQueues');
      let parsed = [];
      try { parsed = JSON.parse(raw); } catch(e) {}
      if (!parsed || !Array.isArray(parsed) || parsed.length === 0) return Object.keys(getAllQueues());
      return parsed;
  }
  function saveVisibleQueues(list) { localStorage.setItem('visibleQueues', JSON.stringify(list)); }

  function formatTime(seconds) { const m = String(Math.floor(seconds / 60)).padStart(2, '0'); const s = String(seconds % 60).padStart(2, '0'); return `${m}:${s}`; }
  function formatSecToHHMM(seconds) {
      if (!seconds) return "0s";
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      if (h > 0) return `${h}h ${m}m`;
      return `${m}m ${s}s`;
  }

  function getQStats(qid) {
      if (!fullStats.daily.queues || !fullStats.daily.queues[qid]) return { ans: 0 };
      return fullStats.daily.queues[qid];
  }
  function detectLanguage(name) { if (!name) return "?"; const u = name.toUpperCase(); if (u.includes("UKR")) return "ukr"; if (u.includes("RU")) return "ru"; if (u.includes("EN")) return "en"; return "?"; }
  function detectName(raw) { if (!raw) return ""; const idx = raw.lastIndexOf(":"); return idx === -1 ? raw : raw.slice(idx + 1).trim(); }

  // --- FETCH STATS ---
  async function fetchStatsOnly() {
      try {
          const res = await fetch(API_URL);
          if (res.ok) {
              const data = await res.json();
              fullStats = data; 
              updateGlobalSummary(); 
              const allQ = Object.keys(getAllQueues());
              allQ.forEach(qid => {
                  updateStatLabels('ls-', qid); 
                  updateStatLabels('l-', qid);
              });
          }
      } catch (e) { console.warn("Stats fetch failed", e); }
  }
  setInterval(fetchStatsOnly, 10000); 
  fetchStatsOnly();

  // --- HISTORY LOGIC ---
  async function openHistory() {
      historyModal.style.display = 'flex';
      historyContent.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
      try {
          const res = await fetch(HISTORY_URL);
          if (!res.ok) throw new Error("Err");
          const historyData = await res.json();
          renderHistory(historyData);
      } catch (e) {
          historyContent.innerHTML = "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∞–±–æ –ø–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è.";
      }
  }
  
  function closeHistory() { historyModal.style.display = 'none'; }

  function renderHistory(data) {
      const dates = Object.keys(data).sort((a,b) => new Date(b) - new Date(a));
      if (dates.length === 0) { historyContent.innerHTML = "–Ü—Å—Ç–æ—Ä—ñ—è –ø—É—Å—Ç–∞."; return; }
      
      let html = '';
      dates.forEach(dateStr => {
          const dayData = data[dateStr];
          const totalAns = dayData.total ? dayData.total.ans : 0;
          const totalWait = dayData.total ? dayData.total.wait : 0;
          const avgWait = totalAns > 0 ? Math.round(totalWait / totalAns) : 0;
          
          html += `
            <div class="history-date-row" onclick="toggleHistoryDetails('${dateStr}')">
                <span>üìÖ ${dateStr}</span>
                <span>Ans: ${totalAns} | Avg Wait: ${formatSecToHHMM(avgWait)}</span>
            </div>
            <div id="hist-${dateStr}" class="history-details">
                <table class="h-table">
                    <thead><tr><th>Hour</th><th>Ans</th><th>Avg Wait</th></tr></thead>
                    <tbody>
          `;
          
          const hours = Object.keys(dayData.hours || {}).sort((a,b) => Number(a) - Number(b));
          hours.forEach(h => {
              const hData = dayData.hours[h];
              const hAvg = hData.ans > 0 ? Math.round(hData.wait / hData.ans) : 0;
              html += `<tr>
                  <td>${h}:00 - ${h}:59</td>
                  <td>${hData.ans}</td>
                  <td>${formatSecToHHMM(hAvg)}</td>
              </tr>`;
          });
          html += `</tbody></table></div>`;
      });
      historyContent.innerHTML = html;
  }
  
  window.toggleHistoryDetails = function(id) {
      const el = document.getElementById(`hist-${id}`);
      if (el) el.classList.toggle('open');
  }

  // --- TOOLTIP & STATS LOGIC ---
  function getTooltipHTML(type, qid) {
      const source = qid ? (fullStats.queuesPeriods[qid] || {}) : fullStats.globalPeriods;
      const h1 = source.h1 || { ans: 0 };
      const h2 = source.h2 || { ans: 0 };
      const h4 = source.h4 || { ans: 0 };
      return `1h: <b>${h1.ans}</b><br>2h: <b>${h2.ans}</b><br>4h: <b>${h4.ans}</b>`;
  }

  function updateStatLabels(prefix, qid) {
      const stats = getQStats(qid);
      const elAns = document.getElementById(`${prefix}ans-${qid}`);
      if(elAns) elAns.textContent = stats.ans;

      const tipAns = document.getElementById(`${prefix}tip-ans-${qid}`);
      if(tipAns) tipAns.innerHTML = getTooltipHTML('ans', qid);
  }

  function updateGlobalSummary() {
      const allQueueIds = Object.keys(getAllQueues());
      let totalWaiting = 0; let maxHold = 0; let busyList = [];
      allQueueIds.forEach(qid => {
          const d = queuesData[qid];
          if(d) {
              const calls = Number(d.queued_calls || 0);
              totalWaiting += calls;
              const h = Number(d.hold || 0);
              if(h > maxHold) maxHold = h;
              if(calls > 0) busyList.push({ name: getAllQueues()[qid] || qid, count: calls });
          }
      });

      document.getElementById('gs-waiting').textContent = totalWaiting;
      const mhEl = document.getElementById('gs-max-hold');
      mhEl.textContent = formatTime(maxHold);
      if(maxHold >= 600) mhEl.classList.add('alert'); else mhEl.classList.remove('alert');

      let totalAns = 0;
      if (fullStats.globalDaily) totalAns = fullStats.globalDaily.ans;
      else if (fullStats.daily.queues) Object.values(fullStats.daily.queues).forEach(s => { totalAns += s.ans; });
      
      document.getElementById('gs-today-ans').textContent = totalAns;
      document.getElementById('tip-g-ans').innerHTML = getTooltipHTML('ans', null);

      const top3Container = document.getElementById('gs-top3');
      if (busyList.length === 0) {
          top3Container.innerHTML = '<div style="opacity:0.5; margin-top:5px;">‚Äî No Calls ‚Äî</div>';
      } else {
          busyList.sort((a, b) => b.count - a.count);
          top3Container.innerHTML = busyList.slice(0, 3).map(item => `<div style="margin-bottom:2px"><span style="color:#ff6b6b;font-weight:bold;margin-right:5px">${item.count}</span><span>${item.name}</span></div>`).join('');
      }
  }

  function updateBlockColor(element, count) {
      const n = Number(count);
      element.classList.remove('status-green', 'status-orange', 'status-red');
      if (n > 10) element.classList.add('status-red');
      else if (n >= 6) element.classList.add('status-orange');
      else if (n >= 1) element.classList.add('status-green'); 
  }

  function createCard(qid, name, data) {
      const card = document.createElement('div');
      card.className = 'card'; card.id = `card-${qid}`; card.setAttribute('draggable', isDragEnabled);
      card.addEventListener('dragstart', handleDragStart); card.addEventListener('dragenter', handleDragEnter);
      card.addEventListener('dragover', handleDragOver); card.addEventListener('drop', handleDrop); card.addEventListener('dragend', handleDragEnd);

      const holdClass = getHoldColorClass(data.hold);
      
      card.innerHTML = `
        <div class="queue-name">${name}</div>
        <div class="queue-id">${qid}</div>
        <div class="queue-count" id="count-${qid}">${data.queued_calls}</div>
        <div class="callers-list" id="callers-${qid}"></div>
        <div class="local-stats-block">
            <div class="stat-container">
                <span>Ans: <b id="ls-ans-${qid}">0</b></span>
                <div class="stat-tooltip" id="ls-tip-ans-${qid}">...</div>
            </div>
            <div class="stat-container">
                <span>Abd: <b id="ls-abd-${qid}" style="color: #c0392b">0</b></span>
                <div class="stat-tooltip" id="ls-tip-abd-${qid}">...</div>
            </div>
            <div class="stat-container">
                <span>SL: <b id="ls-sl-${qid}">0%</b></span>
                <div class="stat-tooltip" id="ls-tip-sl-${qid}">...</div>
            </div>
        </div>
        <div class="queue-info-block" style="margin-top:5px;">
          üë• Logged: <span id="logged-${qid}">${data.logged_in}</span><br>
          ‚úÖ Avalible: <span id="avail-${qid}">${data.available}</span><br>
          ‚è≥ Waiting: <span id="hold-${qid}" class="${holdClass}">${formatTime(data.hold)}</span>
        </div>
      `;
      setTimeout(() => updateStatLabels('ls-', qid), 0);
      updateBlockColor(card, data.queued_calls);
      return card;
  }

  function createListRow(qid, name, data) {
      const tr = document.createElement('tr'); tr.className = 'queue-row'; tr.id = `row-${qid}`; tr.onclick = () => toggleRow(qid);
      const holdClass = getHoldColorClass(data.hold);
      tr.innerHTML = `
        <td><span class="toggle-icon">‚ñ∂</span> <strong>${name}</strong> <span style="font-size:11px;color:#888;">${qid}</span></td>
        <td><span id="l-hold-${qid}" class="${holdClass}" style="font-weight:bold;">${formatTime(data.hold)}</span></td>
        <td><span class="badge" id="l-badge-${qid}">${data.queued_calls}</span></td>
        <td><span id="l-logged-${qid}">${data.logged_in}</span> / <span id="l-avail-${qid}">${data.available}</span></td>
        <td style="font-size:13px; color:#555; white-space: nowrap;">
            <div class="stat-container">
                SL: <span id="l-sl-${qid}" style="font-weight:bold">0%</span>
                <div class="stat-tooltip" id="l-tip-sl-${qid}">...</div>
            </div> | 
            <div class="stat-container">
                Abd: <span id="l-abd-${qid}" style="color:#c0392b; font-weight:bold;">0</span>
                <div class="stat-tooltip" id="l-tip-abd-${qid}">...</div>
            </div> | 
            <div class="stat-container">
                Ans: <span id="l-ans-${qid}" style="color:#27ae60; font-weight:bold;">0</span>
                <div class="stat-tooltip" id="l-tip-ans-${qid}">...</div>
            </div>
        </td>
      `;
      const detailTr = document.createElement('tr'); detailTr.className = 'detail-row'; detailTr.id = `detail-${qid}`;
      detailTr.innerHTML = `<td colspan="5" style="padding:0;"><div class="detail-content"><div class="callers-list" id="l-callers-${qid}"></div></div></td>`;
      setTimeout(() => updateStatLabels('l-', qid), 0);
      updateBlockColor(tr, data.queued_calls);
      return { mainRow: tr, detailRow: detailTr };
  }

  function toggleDragMode() { isDragEnabled = !isDragEnabled; updateDragUI(); }
  function updateDragUI() { dragBtn.textContent = isDragEnabled ? "‚úã" : "üîí"; dragBtn.classList.toggle("active", isDragEnabled); document.body.classList.toggle("drag-enabled", isDragEnabled); document.querySelectorAll('.card').forEach(c => c.setAttribute('draggable', isDragEnabled)); }
  function toggleStatsBar() { const bar = document.getElementById('statsBar'); const btn = document.getElementById('statsToggleIcon'); bar.classList.toggle('minimized'); if (bar.classList.contains('minimized')) { btn.textContent = '‚ñ≤ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'; localStorage.setItem('statsBarMinimized', 'true'); } else { btn.textContent = '‚ñº –°—Ö–æ–≤–∞—Ç–∏'; localStorage.setItem('statsBarMinimized', 'false'); }}
  if (localStorage.getItem('statsBarMinimized') === 'true') { document.getElementById('statsBar').classList.add('minimized'); document.getElementById('statsToggleIcon').textContent = '‚ñ≤ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'; }
  function getHoldColorClass(seconds) { if (seconds >= 600) return 'text-danger'; if (seconds >= 300) return 'text-warn'; return 'text-normal'; }
  function toggleRow(qid) { const row = document.getElementById(`row-${qid}`); const detail = document.getElementById(`detail-${qid}`); if(row && detail) { row.classList.toggle('expanded'); detail.classList.toggle('open'); }}
  function copyText(text, btnElement) { if (!text) return; navigator.clipboard.writeText(text).then(() => { const original = btnElement.textContent; btnElement.textContent = "‚úÖ"; setTimeout(() => btnElement.textContent = original, 1500); }); }
  function acceptCall(callerNumber) { if (!callerNumber) return; const userExt = getUserExt(); if (!userExt) { alert("Extension required!"); openSettings(); return; } window.postMessage({ type: "CONNECT_CALL", userExtension: userExt, targetNumber: callerNumber, source: "queue_monitor" }, "*"); }

  function updateQueueData(qid, raw) {
      queuesData[qid] = { queued_calls: Number(raw.queued_calls), logged_in: raw.logged_in_members, available: raw.available_members, hold: Number(raw.longest_hold_time || 0) };
      const d = queuesData[qid];
      const card = document.getElementById(`card-${qid}`);
      if (card) {
          document.getElementById(`count-${qid}`).textContent = d.queued_calls;
          document.getElementById(`logged-${qid}`).textContent = d.logged_in;
          document.getElementById(`avail-${qid}`).textContent = d.available;
          updateStatLabels('ls-', qid);
          updateBlockColor(card, d.queued_calls);
      }
      const row = document.getElementById(`row-${qid}`);
      if (row) {
          const badge = document.getElementById(`l-badge-${qid}`);
          if(badge) badge.textContent = d.queued_calls;
          document.getElementById(`l-logged-${qid}`).textContent = d.logged_in;
          document.getElementById(`l-avail-${qid}`).textContent = d.available;
          updateStatLabels('l-', qid);
          updateBlockColor(row, d.queued_calls);
      }
      handleTimer(qid, d.hold, d.queued_calls); updateGlobalSummary();
      if (d.queued_calls === 0) { queueCallers[qid] = []; updateCallersList(qid); }
      else if (queueCallers[qid] && queueCallers[qid].length > d.queued_calls) { queueCallers[qid] = queueCallers[qid].slice(0, d.queued_calls); updateCallersList(qid); }
  }

  function handleTimer(qid, startSeconds, count) {
      if (timers[qid]) clearInterval(timers[qid]); let hold = startSeconds;
      const render = (val) => {
          const fmt = formatTime(val); const colorClass = getHoldColorClass(val);
          const gh = document.getElementById(`hold-${qid}`); if(gh) { gh.textContent=fmt; gh.className=colorClass; }
          const lh = document.getElementById(`l-hold-${qid}`); if(lh) { lh.textContent=fmt; lh.className=colorClass; }
      };
      render(hold);
      if (count > 0) timers[qid] = setInterval(() => { hold++; render(hold); updateGlobalSummary(); }, 1000);
  }

  function updateCallersList(qid) {
      const callers = queueCallers[qid] || [];
      const generateHTML = (list) => {
          if (!list.length) return '<div style="color:#999;font-style:italic;">No active callers</div>';
          return list.map((c, i) => {
              const acceptBtn = c.number ? `<span class="action-btn accept-btn" onclick="event.stopPropagation(); acceptCall('${c.number}')">üìû</span>` : '';
              const copyBtn = c.number ? `<span class="action-btn copy-btn" onclick="event.stopPropagation(); copyText('${c.number}', this)">üìã</span>` : '';
              return `<div class="caller-row"><span class="caller-index">${i + 1}.</span>${acceptBtn}<span class="caller-info">üåê ${c.lang.toUpperCase()} ‚Äî ${c.name}</span>${copyBtn}</div>`;
          }).join('');
      };
      const gl = document.getElementById(`callers-${qid}`); if(gl) gl.innerHTML = generateHTML(callers.slice(0, 5));
      const ll = document.getElementById(`l-callers-${qid}`); if(ll) ll.innerHTML = generateHTML(callers);
  }

  function handleDragStart(e) { if (!isDragEnabled) { e.preventDefault(); return false; } dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); this.classList.add('dragging'); }
  function handleDragOver(e) { if (isDragEnabled) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; } return false; }
  function handleDragEnter(e) { if(isDragEnabled) this.classList.add('over'); }
  function handleDragLeave(e) { this.classList.remove('over'); }
  function handleDrop(e) { if (!isDragEnabled) return; if (e.stopPropagation) e.stopPropagation(); this.classList.remove('over'); if (dragSrcEl !== this) { const srcId = dragSrcEl.id.replace('card-', ''); const targetId = this.id.replace('card-', ''); const list = loadVisibleQueues(); const from = list.indexOf(srcId); const to = list.indexOf(targetId); if (from > -1 && to > -1) { list.splice(from, 1); list.splice(to, 0, srcId); saveVisibleQueues(list); renderAll(); } } return false; }
  function handleDragEnd(e) { this.classList.remove('dragging'); this.classList.remove('over'); document.querySelectorAll('.card').forEach(c => { c.classList.remove('over'); c.classList.remove('dragging'); }); }
  let dragSrcEl = null;

  function connectWebSocket() {
    statusEl.textContent = "üîÑ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...";
    const socket = new WebSocket("wss://trackensure.gitstel.net/sw-monitor/?EIO=3&transport=websocket");
    socket.onopen = () => { statusEl.textContent = "‚úÖ –ó'—î–¥–Ω–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"; };
    
    socket.onmessage = (event) => {
      const data = event.data;
      if (data.startsWith('42')) {
        try {
          const payload = JSON.parse(data.slice(2));
          const type = payload[0];
          const d = payload[1];
          if (type === 'queue_times') updateQueueData(d.queue, d);
          if (type === 'queue_caller_join') {
            const { queue, position } = d;
            const number = d.connectedlinenum || d.calleridnum || d.caller_number || "";
            const rawName = d.connectedlinename || d.calleridname || d.caller_name || "";
            const cleanName = detectName(rawName);
            const lang = detectLanguage(rawName);
            let displayText = "‚Äî";
            if (number && cleanName) displayText = `${number} (${cleanName})`; else if (number) displayText = number; else if (cleanName) displayText = cleanName;
            if (queue && position) {
                if (!queueCallers[queue]) queueCallers[queue] = [];
                if (number) queueCallers[queue] = queueCallers[queue].filter(c => c.number !== number);
                const idx = Math.max(Number(position) - 1, 0);
                queueCallers[queue].splice(idx, 0, { name: displayText, number, lang });
                updateCallersList(queue);
            }
          }
          if (type === 'queue_caller_leave' || type === 'queue_caller_abandon') {
             const { queue, position } = d;
             if (queue && queueCallers[queue]) {
                if (position) { const idx = Number(position) - 1; if (idx >= 0) queueCallers[queue].splice(idx, 1); }
                else queueCallers[queue].shift();
                updateCallersList(queue);
             }
          }
        } catch (err) {}
      }
    };
    socket.onclose = () => { statusEl.textContent = "üîå –ó'—î–¥–Ω–∞–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ..."; setTimeout(connectWebSocket, 5000); };
  }

  // --- SETTINGS ---
  function openSettings() {
    settingsForm.innerHTML = `
      <div class="settings-group"><strong>–í–∞—à Extension:</strong><input type="text" name="userExt" value="${getUserExt()}" placeholder="101"></div>
      <div class="settings-group"><strong>–î–æ–¥–∞—Ç–∏ —á–µ—Ä–≥—É:</strong><div class="add-queue-form"><input type="text" id="newQId" placeholder="ID (Q...)"><input type="text" id="newQName" placeholder="Name"><button type="button" class="btn primary" onclick="handleAddClick()">Add</button></div></div>
      <div class="settings-group"><strong>–í–∏–¥–∏–º—ñ —á–µ—Ä–≥–∏:</strong><div id="qList"></div></div>
      <div class="settings-group"><strong>Theme:</strong> <label><input type="radio" name="theme" value="light" ${getTheme()==='light'?'checked':''}> Light</label> <label><input type="radio" name="theme" value="dark" ${getTheme()==='dark'?'checked':''}> Dark</label></div>
    `;
    const qList = document.getElementById('qList');
    const visible = loadVisibleQueues(); const custom = getCustomQueues();
    Object.entries(getAllQueues()).forEach(([qid, name]) => {
      const isCustom = custom.hasOwnProperty(qid);
      const delBtn = isCustom ? `<button class="delete-q-btn" onclick="event.preventDefault(); removeCustomQueue('${qid}')">üóëÔ∏è</button>` : '';
      const div = document.createElement('div');
      div.innerHTML = `<label><span><input type="checkbox" name="queues" value="${qid}" ${visible.includes(qid) ? 'checked' : ''}> ${qid} - ${name} ${isCustom?'(Custom)':''}</span>${delBtn}</label>`;
      qList.appendChild(div);
    });
    settingsModal.style.display = 'flex';
  }
  function handleAddClick() { const id = document.getElementById('newQId').value; const name = document.getElementById('newQName').value; if(id && name) { const c = getCustomQueues(); c[id]=name; localStorage.setItem('customQueues', JSON.stringify(c)); openSettings(); }}
  function removeCustomQueue(id) { const c = getCustomQueues(); delete c[id]; localStorage.setItem('customQueues', JSON.stringify(c)); openSettings(); }
  function closeSettings() { settingsModal.style.display = 'none'; }
  function saveSettings() {
      const fd = new FormData(settingsForm);
      const sel = fd.getAll('queues');
      let order = loadVisibleQueues().filter(id => sel.includes(id));
      sel.forEach(id => { if(!order.includes(id)) order.push(id); });
      saveVisibleQueues(order);
      localStorage.setItem('theme', fd.get('theme')); localStorage.setItem('userExt', fd.get('userExt'));
      document.body.className = fd.get('theme');
      renderAll(); closeSettings();
  }

  // --- INIT ---
  document.body.className = getTheme();
  switchView(currentView);
  connectWebSocket();
</script>
</body>
</html>
