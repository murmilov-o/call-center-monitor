<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–≥</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      padding-bottom: 80px; /* –£–≤–µ–ª–∏—á–∏–ª–∏ –æ—Ç—Å—Ç—É–ø –¥–ª—è –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª–∏ */
      margin: 0;
      transition: background 0.3s, color 0.3s;
      background: #f2f2f2;
      color: #000;
    }

    body.dark {
      background: #1e1e1e;
      color: #ddd;
    }

    /* --- Utilities --- */
    .hidden { display: none !important; }
    
    /* Threshold Colors */
    .text-normal { color: inherit; }
    .text-warn { color: #d35400; font-weight: bold; } /* > 5 min */
    .text-danger { color: #c0392b; font-weight: 900; animation: pulse 2s infinite; } /* > 10 min */
    
    body.dark .text-warn { color: #f39c12; }
    body.dark .text-danger { color: #e74c3c; }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    /* --- Top Bar --- */
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    h1 { margin: 0; font-size: 24px; }
    #status { margin-bottom: 20px; font-size: 14px; color: #666; }
    body.dark #status { color: #aaa; }

    .controls { display: flex; gap: 8px; }

    .btn {
      cursor: pointer; font-size: 16px; background: #fff; border: 1px solid #ccc;
      padding: 6px 12px; border-radius: 6px; transition: 0.2s; display: inline-flex;
      align-items: center; justify-content: center;
    }
    .btn:hover { background-color: #e9e9e9; }
    .btn.active { background-color: #d4edda; border-color: #28a745; color: #155724; }
    
    body.dark .btn { background: #444; border-color: #666; color: #eee; }
    body.dark .btn:hover { background-color: #555; }
    body.dark .btn.active { background-color: #235d3a; border-color: #28a745; color: #fff; }

    /* --- GRID VIEW --- */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .card {
      background: white; border-radius: 12px; padding: 20px 22px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column;
      justify-content: space-between; transition: box-shadow 0.3s, transform 0.2s;
      min-height: 250px;
    }
    body.dark .card { background: #2e2e2e; color: #eee; }
    
    body.drag-enabled .card { cursor: grab; }
    body.drag-enabled .card:active { cursor: grabbing; }
    .card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    .card.dragging { opacity: 0.4; border: 2px dashed #999; }
    .card.over { border: 2px dashed #4CAF50; transform: scale(1.02); }

    .queue-name { font-weight: bold; font-size: 18px; margin-bottom: 4px; pointer-events: none; }
    .queue-id { font-size: 13px; color: #565656; margin-bottom: 10px; pointer-events: none; }
    body.dark .queue-id { color: #dcdcdc; }
    .queue-count { font-size: 40px; font-weight: bold; margin-bottom: 10px; pointer-events: none; }

    /* --- LIST VIEW --- */
    .list-container { width: 100%; overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    body.dark .list-container { background: #2e2e2e; }
    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    th { text-align: left; padding: 12px 15px; border-bottom: 2px solid #ddd; font-size: 14px; color: #555; background-color: #f8f8f8; }
    body.dark th { border-color: #444; color: #aaa; background-color: #333; }
    td { padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 15px; }
    body.dark td { border-color: #444; }
    .queue-row { cursor: pointer; transition: background 0.1s; }
    .queue-row:hover { background-color: #f0f0f0; }
    body.dark .queue-row:hover { background-color: #383838; }
    .detail-row { display: none; background-color: #fafafa; }
    body.dark .detail-row { background-color: #252525; }
    .detail-row.open { display: table-row; }
    .detail-content { padding: 15px; max-height: 300px; overflow-y: auto; border-bottom: 1px solid #ddd; }
    .toggle-icon { display: inline-block; width: 20px; transition: transform 0.2s; color: #888; }
    .queue-row.expanded .toggle-icon { transform: rotate(90deg); }
    .badge { padding: 4px 10px; border-radius: 6px; font-weight: bold; font-size: 14px; }
    .bg-low { background: #d4edda; color: #155724; }
    .bg-med { background: #fff3cd; color: #5c4604; }
    .bg-high { background: #f8d7da; color: #721c24; }
    body.dark .bg-low { background: #235d3a; color: #ebffea; }
    body.dark .bg-med { background: #665700; color: #fff3cd; }
    body.dark .bg-high { background: #5b1f1f; color: #f8d7da; }

    /* Callers List */
    .callers-list { font-size: 14px; line-height: 1.6; flex-grow: 1; margin: 6px 0 8px 0; }
    .caller-row { display: flex; align-items: center; margin-bottom: 5px; border-bottom: 1px dotted #eee; padding-bottom: 2px;}
    body.dark .caller-row { border-color: #444; }
    .caller-row:last-child { border-bottom: none; }
    .caller-index { margin-right: 8px; font-weight: bold; color: #888; min-width: 20px; }
    .caller-info { white-space: normal; overflow: visible; flex-grow: 1; margin: 0 5px; }
    .action-btn { cursor: pointer; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; transition: 0.2s; font-size: 16px; }
    .action-btn:hover { background-color: rgba(0,0,0,0.1); transform: scale(1.1); }
    body.dark .action-btn:hover { background-color: rgba(255,255,255,0.1); }
    .accept-btn { color: #28a745; margin-right: 4px; }
    .copy-btn { opacity: 0.6; } .copy-btn:hover { opacity: 1; }

    /* GLOBAL SUMMARY BAR */
    .global-stats {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: #2c3e50; color: white;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 2000;
        display: flex; justify-content: center; align-items: flex-start; /* Aligned to top to handle list */
        padding: 10px 0; font-size: 15px; gap: 40px;
        min-height: 60px;
    }
    body.dark .global-stats { background: #252525; border-top: 1px solid #444; }
    
    .g-stat-item { text-align: center; min-width: 130px; }
    .g-stat-label { font-size: 11px; opacity: 0.7; display: block; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; }
    .g-stat-value { font-size: 22px; font-weight: bold; line-height: 1.2; }
    .g-stat-value.alert { color: #e74c3c; animation: pulse 1s infinite; }

    /* Top 3 List Styles */
    .top-list { font-size: 13px; text-align: left; display: inline-block; }
    .top-item { margin-bottom: 2px; white-space: nowrap; }
    .top-count { color: #ff6b6b; font-weight: bold; margin-right: 5px; min-width: 15px; display: inline-block; text-align: right;}
    body.dark .top-count { color: #ff8787; }

    /* Modals & Settings */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 20px; border-radius: 12px; width: 360px; max-height: 85vh; overflow-y: auto; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
    body.dark .modal-content { background: #2b2b2b; color: #eee; }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .modal-buttons button { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; }
    .save-btn { background: #4CAF50; color: white; }
    .cancel-btn { background: #ccc; }
    .settings-group { margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
    body.dark .settings-group { border-color: #444; }
    input[type="text"], select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; background: #fff; color: #000; box-sizing: border-box; }
    body.dark input[type="text"], body.dark select { background: #3a3a3a; border-color: #666; color: #eee; }
    .add-queue-form { display: flex; gap: 5px; margin-top: 10px; }
    .add-queue-form button { background: #007bff; color: white; border: none; border-radius: 4px; padding: 0 10px; cursor: pointer; }
    .delete-q-btn { background: transparent; border: none; color: #ff4444; cursor: pointer; }

    /* Cheatsheet */
    .cheatsheet { margin-top: 30px; padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 40px; margin-bottom: 90px; }
    body.dark .cheatsheet { background: #2e2e2e; color: #eee; }
    .cheatsheet ul { list-style: none; padding: 0; margin: 0; }
    .cheatsheet li { margin: 4px 0; font-size: 14px; }
    .cheatsheet h3 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    body.dark .cheatsheet h3 { border-color: #444; }
    .queue-info-block { font-size: 12px; text-align: left; }
  </style>
</head>
<body>

<div class="top-bar">
  <h1>üìû –ê–∫—Ç–∏–≤–Ω—ñ —á–µ—Ä–≥–∏</h1>
  <div class="controls">
      <button class="btn active" id="viewGridBtn" onclick="switchView('grid')" title="–ü–ª–∏—Ç–∫–∞">üî≤</button>
      <button class="btn" id="viewListBtn" onclick="switchView('list')" title="–°–ø–∏—Å–æ–∫">‚ò∞</button>
      <div style="width: 1px; background: #ccc; margin: 0 5px;"></div>
      <button class="btn drag-toggle-btn" id="dragBtn" onclick="toggleDragMode()" title="–†–µ–∂–∏–º –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è">üîí</button>
      <button class="btn settings-btn" onclick="openSettings()">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
  </div>
</div>

<div id="status">üîÑ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>

<div class="grid" id="queuesGrid"></div>

<div class="list-container hidden" id="queuesList">
  <table>
    <thead>
      <tr>
        <th style="width: 35%">Queue Name</th>
        <th style="width: 20%">Max Call Waiting</th>
        <th style="width: 20%">Waiting Callers</th>
        <th style="width: 25%">Logged In / Available</th>
      </tr>
    </thead>
    <tbody id="listBody"></tbody>
  </table>
</div>

<div class="global-stats">
    <div class="g-stat-item">
        <span class="g-stat-label">Total Waiting</span>
        <span class="g-stat-value" id="gs-waiting">0</span>
    </div>
    
    <div class="g-stat-item">
        <span class="g-stat-label">üî• Top 3 Busy</span>
        <div id="gs-top3" class="top-list">
            <div style="opacity:0.5; font-size:12px; margin-top:5px;">‚Äî No Calls ‚Äî</div>
        </div>
    </div>

    <div class="g-stat-item">
        <span class="g-stat-label">Max Wait Time</span>
        <span class="g-stat-value" id="gs-max-hold">00:00</span>
    </div>
    
    <div class="g-stat-item">
        <span class="g-stat-label">Busy Queues</span>
        <span class="g-stat-value" id="gs-busy-queues">0</span>
    </div>
</div>

<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <form id="settingsForm"></form>
    <div class="modal-buttons">
      <button type="button" class="cancel-btn" onclick="closeSettings()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button type="button" class="save-btn" onclick="saveSettings()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>
</div>

<div class="cheatsheet">
  <div>
    <h3>üìå Prefixes | Call numbers</h3>
    <ul>
      <li>TrackEnsure Support: <strong>04</strong> +1(916)860-1234</li>
      <li>Alfa Support: <strong>06</strong> +1(469)445-27-57</li>
      <li>Vista Support: <strong>09</strong> +1(614)362-22-23 </li>
      <li>Swift Support: <strong>08</strong> +1(678)387-51-75</li>
      <li>Sharp Support: <strong>03</strong> +1(862)208-38-48</li>
      <li>Club Support: <strong>02</strong> +1(615)900-55-51 </li>
      <li>Pro-TracKing Support: <strong>11</strong> +1(623)887-44-22</li>
      <li>Smart eLog Support: <strong>13</strong> +1(916)740-66-74</li>
      <li>KGZ: <strong>12</strong> +1(217)401-12-22</li>
    </ul>
  </div>
  <div>
    <h3>üíº Sales</h3>
    <ul>
      <li>TrackEnsure Sales: <strong>704</strong></li>
      <li>Alfa Sales: <strong>725</strong></li>
      <li>Vista Sales: <strong>726</strong></li>
      <li>Swift Sales: <strong>728</strong></li>
      <li>Sharp Sales: <strong>755</strong></li>
      <li>Club Sales: <strong>746</strong></li>
      <li>Pro-TracKing Sales: <strong>782</strong></li>
      <li>Smart eLog Sales: <strong>812</strong></li>
    </ul>
  </div>
</div>

<script>
  let currentView = localStorage.getItem('viewMode') || 'grid';
  let isDragEnabled = false;
  
  const queueCallers = {}; 
  const queuesData = {};   
  const timers = {};       

  const statusEl = document.getElementById('status');
  const gridEl = document.getElementById('queuesGrid');
  const listEl = document.getElementById('queuesList');
  const listBody = document.getElementById('listBody');
  const settingsModal = document.getElementById('settingsModal');
  const settingsForm = document.getElementById('settingsForm');
  const dragBtn = document.getElementById('dragBtn');

  const defaultQueueNames = {
    Q700: "TrackEnsure Support",
    Q701: "TrackEnsure Support rus/ukr",
    Q801: "Callback rus/ukr",
    Q800: "Callback",
    Q791: "TrackEnsure New",
    Q750: "VIP Queue",
    Q702: "Fleet Supp",
    Q710: "Alfa Support",
    Q733: "Alfa VIP",
    Q720: "Vista Support",
    Q734: "Vista VIP",
    Q740: "Swift Support",
    Q760: "Swift VIP",
    Q766: "Sharp Support",
    Q745: "Club Support",
    Q781: "Pro-TracKing Support",
    Q730: "Smart eLog Support",
    Q777: "KGZ"
  };

  const translations = {
    ua: {
      title: "üìû –ê–∫—Ç–∏–≤–Ω—ñ —á–µ—Ä–≥–∏",
      connecting: "üîÑ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...",
      connected: "‚úÖ –ó'—î–¥–Ω–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ",
      error: "‚ùó –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è",
      lost: "üîå –ó'—î–¥–Ω–∞–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ, –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...",
      settings: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
      visibleQueues: "–í–∏–¥–∏–º—ñ —á–µ—Ä–≥–∏:",
      addQueue: "–î–æ–¥–∞—Ç–∏ —á–µ—Ä–≥—É:",
      add: "–î–æ–¥–∞—Ç–∏",
      save: "–ó–±–µ—Ä–µ–≥—Ç–∏",
      cancel: "–°–∫–∞—Å—É–≤–∞—Ç–∏",
      light: "–°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞",
      dark: "–¢–µ–º–Ω–∞ —Ç–µ–º–∞",
      language: "–ú–æ–≤–∞ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É",
      phId: "ID (Q777)",
      phName: "–ù–∞–∑–≤–∞",
      copied: "–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!",
      accept: "–ü—Ä–∏–π–Ω—è—Ç–∏",
      userExt: "–í–∞—à –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –Ω–æ–º–µ—Ä (Extension):",
      userExtPh: "–Ω–∞–ø—Ä. 101"
    },
    ru: {
      title: "üìû –ê–∫—Ç–∏–≤–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏",
      connecting: "üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...",
      connected: "‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ",
      error: "‚ùó –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è",
      lost: "üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...",
      settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
      visibleQueues: "–í–∏–¥–∏–º—ã–µ –æ—á–µ—Ä–µ–¥–∏:",
      addQueue: "–î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å:",
      add: "–î–æ–±–∞–≤–∏—Ç—å",
      save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
      cancel: "–û—Ç–º–µ–Ω–∞",
      light: "–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞",
      dark: "–¢—ë–º–Ω–∞—è —Ç–µ–º–∞",
      language: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
      phId: "ID (Q777)",
      phName: "–ù–∞–∑–≤–∞–Ω–∏–µ",
      copied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
      accept: "–ü—Ä–∏–Ω—è—Ç—å",
      userExt: "–í–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä (Extension):",
      userExtPh: "–Ω–∞–ø—Ä. 101"
    },
    en: {
      title: "üìû Active Queues",
      connecting: "üîÑ Connecting...",
      connected: "‚úÖ Connected",
      error: "‚ùó Connection Error",
      lost: "üîå Connection lost, reconnecting...",
      settings: "Settings",
      visibleQueues: "Visible queues:",
      addQueue: "Add Queue:",
      add: "Add",
      save: "Save",
      cancel: "Cancel",
      light: "Light theme",
      dark: "Dark theme",
      language: "Language",
      phId: "ID (Q777)",
      phName: "Name",
      copied: "Copied!",
      accept: "Accept",
      userExt: "Your Extension:",
      userExtPh: "e.g. 101"
    }
  };

  function getLang() { return localStorage.getItem('lang') || 'ua'; }
  function getTheme() { return localStorage.getItem('theme') || 'light'; }
  function getUserExt() { return localStorage.getItem('userExt') || ''; }
  function getCustomQueues() { return JSON.parse(localStorage.getItem('customQueues') || '{}'); }
  function getAllQueues() { return { ...defaultQueueNames, ...getCustomQueues() }; }
  function loadVisibleQueues() { return JSON.parse(localStorage.getItem('visibleQueues') || JSON.stringify(Object.keys(getAllQueues()))); }
  function saveVisibleQueues(list) { localStorage.setItem('visibleQueues', JSON.stringify(list)); }
  function formatTime(seconds) {
    const m = String(Math.floor(seconds / 60)).padStart(2, '0');
    const s = String(seconds % 60).padStart(2, '0');
    return `${m}:${s}`;
  }

  function switchView(mode) {
      currentView = mode;
      localStorage.setItem('viewMode', mode);
      const gridBtn = document.getElementById('viewGridBtn');
      const listBtn = document.getElementById('viewListBtn');
      
      if (mode === 'grid') {
          gridEl.classList.remove('hidden');
          listEl.classList.add('hidden');
          gridBtn.classList.add('active');
          listBtn.classList.remove('active');
          dragBtn.style.display = 'inline-flex';
      } else {
          gridEl.classList.add('hidden');
          listEl.classList.remove('hidden');
          gridBtn.classList.remove('active');
          listBtn.classList.add('active');
          dragBtn.style.display = 'none';
          isDragEnabled = false;
          updateDragUI();
      }
      renderAll();
  }

  function toggleDragMode() {
      isDragEnabled = !isDragEnabled;
      updateDragUI();
  }
  function updateDragUI() {
      if (isDragEnabled) {
          dragBtn.textContent = "‚úã";
          dragBtn.classList.add("active");
          document.body.classList.add("drag-enabled");
      } else {
          dragBtn.textContent = "üîí";
          dragBtn.classList.remove("active");
          document.body.classList.remove("drag-enabled");
      }
      document.querySelectorAll('.card').forEach(c => c.setAttribute('draggable', isDragEnabled));
  }

  function getHoldColorClass(seconds) {
      if (seconds >= 600) return 'text-danger'; 
      if (seconds >= 300) return 'text-warn';   
      return 'text-normal';
  }

  function renderAll() {
      const visibleQueues = loadVisibleQueues();
      const allQueues = getAllQueues();

      gridEl.innerHTML = '';
      listBody.innerHTML = '';

      visibleQueues.forEach(qid => {
          const name = allQueues[qid] || qid;
          const data = queuesData[qid] || { queued_calls: 0, logged_in: "-", available: "-", hold: 0 };
          
          gridEl.appendChild(createCard(qid, name, data));
          
          const { mainRow, detailRow } = createListRow(qid, name, data);
          listBody.appendChild(mainRow);
          listBody.appendChild(detailRow);

          updateCallersList(qid);
      });
      updateGlobalSummary();
  }

  function createCard(qid, name, data) {
      const card = document.createElement('div');
      card.className = 'card';
      card.id = `card-${qid}`;
      card.setAttribute('draggable', isDragEnabled);
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragenter', handleDragEnter);
      card.addEventListener('dragover', handleDragOver);
      card.addEventListener('dragleave', handleDragLeave);
      card.addEventListener('drop', handleDrop);
      card.addEventListener('dragend', handleDragEnd);

      const holdClass = getHoldColorClass(data.hold);

      card.innerHTML = `
        <div class="queue-name">${name}</div>
        <div class="queue-id">${qid}</div>
        <div class="queue-count" id="count-${qid}">${data.queued_calls}</div>
        <div class="callers-list" id="callers-${qid}"></div>
        <div class="queue-info-block">
          üë• Logged: <span id="logged-${qid}">${data.logged_in}</span><br>
          ‚úÖ Avalible: <span id="avail-${qid}">${data.available}</span><br>
          ‚è≥ Waiting: <span id="hold-${qid}" class="${holdClass}">${formatTime(data.hold)}</span>
        </div>
      `;
      updateColorClass(card, data.queued_calls);
      return card;
  }

  function createListRow(qid, name, data) {
      const tr = document.createElement('tr');
      tr.className = 'queue-row';
      tr.id = `row-${qid}`;
      tr.onclick = () => toggleRow(qid);
      const holdClass = getHoldColorClass(data.hold);

      tr.innerHTML = `
        <td><span class="toggle-icon">‚ñ∂</span> <strong>${name}</strong> <span style="font-size:11px;color:#888;margin-left:5px;">${qid}</span></td>
        <td><span id="l-hold-${qid}" class="${holdClass}" style="font-weight:bold;">${formatTime(data.hold)}</span></td>
        <td><span class="badge" id="l-badge-${qid}">${data.queued_calls}</span></td>
        <td><span id="l-logged-${qid}">${data.logged_in}</span> / <span id="l-avail-${qid}">${data.available}</span></td>
      `;

      const detailTr = document.createElement('tr');
      detailTr.className = 'detail-row';
      detailTr.id = `detail-${qid}`;
      detailTr.innerHTML = `<td colspan="4" style="padding:0;"><div class="detail-content"><div class="callers-list" id="l-callers-${qid}"></div></div></td>`;
      updateRowColor(tr, data.queued_calls);
      return { mainRow: tr, detailRow: detailTr };
  }

  function toggleRow(qid) {
      const row = document.getElementById(`row-${qid}`);
      const detail = document.getElementById(`detail-${qid}`);
      if(row && detail) {
          row.classList.toggle('expanded');
          detail.classList.toggle('open');
      }
  }

  function updateColorClass(el, count) {
      el.classList.remove('queue-low', 'queue-medium', 'queue-high');
      const num = Number(count);
      if (num >= 5) el.classList.add('queue-high');
      else if (num >= 3) el.classList.add('queue-medium');
      else if (num >= 1) el.classList.add('queue-low');
  }
  function updateRowColor(row, count) {
      const badge = row.querySelector('.badge');
      if(badge) {
          badge.className = 'badge';
          const num = Number(count);
          if (num >= 5) badge.classList.add('bg-high');
          else if (num >= 3) badge.classList.add('bg-med');
          else if (num >= 1) badge.classList.add('bg-low');
      }
  }

  // --- GLOBAL STATS LOGIC ---
  function updateGlobalSummary() {
      const allQueues = getAllQueues();
      const allQueueIds = Object.keys(allQueues);
      
      let totalWaiting = 0;
      let maxHold = 0;
      let busyQueuesCount = 0;
      
      // Array for top 3 calculation: { name, count }
      let busyList = [];

      allQueueIds.forEach(qid => {
          const d = queuesData[qid];
          if(d) {
              const calls = Number(d.queued_calls || 0);
              totalWaiting += calls;
              const h = Number(d.hold || 0);
              if(h > maxHold) maxHold = h;
              
              if(calls > 0) {
                  busyQueuesCount++;
                  busyList.push({
                      name: allQueues[qid] || qid,
                      count: calls
                  });
              }
          }
      });

      // Update Basic Stats
      document.getElementById('gs-waiting').textContent = totalWaiting;
      document.getElementById('gs-busy-queues').textContent = busyQueuesCount;
      
      const mhEl = document.getElementById('gs-max-hold');
      mhEl.textContent = formatTime(maxHold);
      if(maxHold >= 600) mhEl.classList.add('alert');
      else mhEl.classList.remove('alert');

      // Update Top 3 List
      const top3Container = document.getElementById('gs-top3');
      if (busyList.length === 0) {
          top3Container.innerHTML = '<div style="opacity:0.5; font-size:12px; margin-top:5px;">‚Äî No Calls ‚Äî</div>';
      } else {
          // Sort desc by count
          busyList.sort((a, b) => b.count - a.count);
          // Take top 3
          const top3 = busyList.slice(0, 3);
          
          top3Container.innerHTML = top3.map(item => `
              <div class="top-item">
                  <span class="top-count">${item.count}</span>
                  <span>${item.name}</span>
              </div>
          `).join('');
      }
  }

  function copyText(text, btnElement) {
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
          const original = btnElement.textContent;
          btnElement.textContent = "‚úÖ";
          setTimeout(() => btnElement.textContent = original, 1500);
      });
  }
  function acceptCall(callerNumber) {
      if (!callerNumber) return;
      const userExt = getUserExt();
      if (!userExt) {
          alert("–í–∫–∞–∂—ñ—Ç—å Extension —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö!");
          openSettings();
          return;
      }
      window.postMessage({ type: "CONNECT_CALL", userExtension: userExt, targetNumber: callerNumber, source: "queue_monitor" }, "*");
  }

  function updateQueueData(qid, raw) {
      const { queued_calls, logged_in_members, available_members, longest_hold_time } = raw;
      
      queuesData[qid] = {
          queued_calls: Number(queued_calls),
          logged_in: logged_in_members,
          available: available_members,
          hold: Number(longest_hold_time || 0)
      };
      
      const d = queuesData[qid];

      const card = document.getElementById(`card-${qid}`);
      if (card) {
          updateText(`count-${qid}`, d.queued_calls);
          updateText(`logged-${qid}`, d.logged_in);
          updateText(`avail-${qid}`, d.available);
          updateColorClass(card, d.queued_calls);
      }

      const row = document.getElementById(`row-${qid}`);
      if (row) {
          updateText(`l-badge-${qid}`, d.queued_calls);
          updateText(`l-logged-${qid}`, d.logged_in);
          updateText(`l-avail-${qid}`, d.available);
          updateRowColor(row, d.queued_calls);
      }
      
      handleTimer(qid, d.hold, d.queued_calls);
      updateGlobalSummary(); 
      
      if (d.queued_calls === 0 && queueCallers[qid] && queueCallers[qid].length > 0) {
          queueCallers[qid] = [];
          updateCallersList(qid);
      } else if (queueCallers[qid] && queueCallers[qid].length > d.queued_calls) {
          queueCallers[qid] = queueCallers[qid].slice(0, d.queued_calls);
          updateCallersList(qid);
      }
  }

  function updateText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
  }

  function handleTimer(qid, startSeconds, count) {
      if (timers[qid]) clearInterval(timers[qid]);
      let hold = startSeconds;
      
      const render = (val) => {
          const fmt = formatTime(val);
          const colorClass = getHoldColorClass(val);
          
          const gridHold = document.getElementById(`hold-${qid}`);
          if (gridHold) { gridHold.textContent = fmt; gridHold.className = colorClass; }
          const listHold = document.getElementById(`l-hold-${qid}`);
          if (listHold) { listHold.textContent = fmt; listHold.className = colorClass; }
      };

      render(hold);

      if (count > 0) {
          timers[qid] = setInterval(() => {
              hold++;
              render(hold);
              updateGlobalSummary(); 
          }, 1000);
      }
  }

  function updateCallersList(qid) {
      const callers = queueCallers[qid] || [];
      const t = translations[getLang()];
      
      const generateHTML = (list) => {
          if (!list.length) return '<div style="color:#999;font-style:italic;">No active callers</div>';
          return list.map((c, i) => {
              const acceptBtn = c.number ? `<span class="action-btn accept-btn" onclick="event.stopPropagation(); acceptCall('${c.number}')" title="${t.accept}">üìû</span>` : '';
              const copyBtn = c.number ? `<span class="action-btn copy-btn" onclick="event.stopPropagation(); copyText('${c.number}', this)" title="${t.copied}">üìã</span>` : '';
              return `<div class="caller-row"><span class="caller-index">${i + 1}.</span>${acceptBtn}<span class="caller-info">üåê ${c.lang.toUpperCase()} ‚Äî ${c.name}</span>${copyBtn}</div>`;
          }).join('');
      };

      const gridListEl = document.getElementById(`callers-${qid}`);
      if(gridListEl) gridListEl.innerHTML = generateHTML(callers.slice(0, 5));

      const listListEl = document.getElementById(`l-callers-${qid}`);
      if(listListEl) listListEl.innerHTML = generateHTML(callers);
  }

  let dragSrcEl = null;
  function handleDragStart(e) { if (!isDragEnabled) { e.preventDefault(); return false; } dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); this.classList.add('dragging'); }
  function handleDragOver(e) { if (isDragEnabled) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; } return false; }
  function handleDragEnter(e) { if(isDragEnabled) this.classList.add('over'); }
  function handleDragLeave(e) { this.classList.remove('over'); }
  function handleDrop(e) {
      if (!isDragEnabled) return;
      if (e.stopPropagation) e.stopPropagation();
      this.classList.remove('over');
      if (dragSrcEl !== this) {
          const srcId = dragSrcEl.id.replace('card-', '');
          const targetId = this.id.replace('card-', '');
          const list = loadVisibleQueues();
          const from = list.indexOf(srcId);
          const to = list.indexOf(targetId);
          if (from > -1 && to > -1) { list.splice(from, 1); list.splice(to, 0, srcId); saveVisibleQueues(list); renderAll(); }
      }
      return false;
  }
  function handleDragEnd(e) { this.classList.remove('dragging'); this.classList.remove('over'); document.querySelectorAll('.card').forEach(c => { c.classList.remove('over'); c.classList.remove('dragging'); }); }

  function connectWebSocket() {
    statusEl.textContent = translations[getLang()].connecting;
    socket = new WebSocket("wss://trackensure.gitstel.net/sw-monitor/?EIO=3&transport=websocket");
    socket.onopen = () => { reconnectAttempts = 0; statusEl.textContent = translations[getLang()].connected; };
    
    function detectLanguage(name) { const u = name.toUpperCase(); if (u.includes("UKR")) return "ukr"; if (u.includes("RU")) return "ru"; if (u.includes("EN")) return "en"; return "?"; }
    function detectName(raw) { const idx = raw.lastIndexOf(":"); return idx === -1 ? raw : raw.slice(idx + 1).trim(); }

    socket.onmessage = (event) => {
      const data = event.data;
      if (data.startsWith('42')) {
        try {
          const payload = JSON.parse(data.slice(2));
          const type = payload[0];
          const d = payload[1];
          const allQs = getAllQueues();

          if (type === 'queue_times') {
             // UPDATE DATA FOR ALL QUEUES (even hidden ones), so Global Stats work
             updateQueueData(d.queue, d);
          }
          if (type === 'queue_caller_join') {
            const { queue, position } = d;
            if (!queue || !position) return;
            const number = d.connectedlinenum || d.calleridnum || d.caller_number || "";
            const rawName = d.connectedlinename || d.calleridname || d.caller_name || "";
            const cleanName = detectName(rawName);
            const lang = detectLanguage(rawName);
            let displayText = "‚Äî";
            if (number && cleanName) displayText = `${number} (${cleanName})`;
            else if (number) displayText = number;
            else if (cleanName) displayText = cleanName;

            if (!queueCallers[queue]) queueCallers[queue] = [];
            if (number) queueCallers[queue] = queueCallers[queue].filter(c => c.number !== number);
            const idx = Math.max(Number(position) - 1, 0);
            queueCallers[queue].splice(idx, 0, { name: displayText, number, lang });
            updateCallersList(queue);
          }
          if (type === 'queue_caller_leave' || type === 'queue_caller_abandon') {
             const { queue, position } = d;
             if (queue && queueCallers[queue]) {
                if (position) { const idx = Number(position) - 1; if (idx >= 0) queueCallers[queue].splice(idx, 1); }
                else queueCallers[queue].shift();
                updateCallersList(queue);
             }
          }
        } catch (err) { console.warn("Parse error:", err); }
      }
    };
    socket.onclose = () => { statusEl.textContent = translations[getLang()].lost; setTimeout(() => { reconnectAttempts++; connectWebSocket(); }, Math.min(5000, 1000 + reconnectAttempts * 1000)); };
  }

  function openSettings() {
    settingsForm.innerHTML = '';
    const t = translations[getLang()];
    const extGroup = document.createElement('div'); extGroup.className = 'settings-group';
    extGroup.innerHTML = `<strong>${t.userExt}</strong><input type="text" name="userExt" value="${getUserExt()}" placeholder="${t.userExtPh}">`;
    settingsForm.appendChild(extGroup);
    
    const queuesGroup = document.createElement('div'); queuesGroup.className = 'settings-group';
    const visible = loadVisibleQueues(); const custom = getCustomQueues();
    Object.entries(getAllQueues()).forEach(([qid, name]) => {
      const isCustom = custom.hasOwnProperty(qid);
      const delBtn = isCustom ? `<button class="delete-q-btn" onclick="event.preventDefault(); removeCustomQueue('${qid}')">üóëÔ∏è</button>` : '';
      const div = document.createElement('div');
      div.innerHTML = `<label><span><input type="checkbox" name="queues" value="${qid}" ${visible.includes(qid) ? 'checked' : ''}> ${qid} - ${name} ${isCustom?'(Custom)':''}</span>${delBtn}</label>`;
      queuesGroup.appendChild(div);
    });
    settingsForm.appendChild(queuesGroup);
    
    const addGroup = document.createElement('div'); addGroup.className = 'settings-group';
    addGroup.innerHTML = `<strong>${t.addQueue}</strong><div class="add-queue-form"><input type="text" id="newQId" placeholder="${t.phId}"><input type="text" id="newQName" placeholder="${t.phName}"><button type="button" onclick="handleAddClick()">${t.add}</button></div>`;
    settingsForm.appendChild(addGroup);
    
    const ui = document.createElement('div'); ui.className='settings-group';
    ui.innerHTML = `<div><strong>Theme:</strong> <label style="display:inline"><input type="radio" name="theme" value="light" ${getTheme()==='light'?'checked':''}> Light</label> <label style="display:inline"><input type="radio" name="theme" value="dark" ${getTheme()==='dark'?'checked':''}> Dark</label></div>`;
    settingsForm.appendChild(ui);
    settingsModal.style.display = 'flex';
  }
  function handleAddClick() { const id = document.getElementById('newQId').value; const name = document.getElementById('newQName').value; if(id && name) { const c = getCustomQueues(); c[id]=name; localStorage.setItem('customQueues', JSON.stringify(c)); openSettings(); }}
  function removeCustomQueue(id) { const c = getCustomQueues(); delete c[id]; localStorage.setItem('customQueues', JSON.stringify(c)); openSettings(); }
  function closeSettings() { settingsModal.style.display = 'none'; }
  function saveSettings() {
      const fd = new FormData(settingsForm);
      const sel = fd.getAll('queues');
      let order = loadVisibleQueues().filter(id => sel.includes(id));
      sel.forEach(id => { if(!order.includes(id)) order.push(id); });
      saveVisibleQueues(order);
      localStorage.setItem('theme', fd.get('theme'));
      localStorage.setItem('userExt', fd.get('userExt'));
      document.body.className = fd.get('theme');
      renderAll(); closeSettings();
  }

  document.body.className = getTheme();
  switchView(currentView);
  connectWebSocket();

</script>
</body>
</html>
