<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–≥</title>
  <style>
    /* --- GLOBAL RESET & UTILS --- */
    * { box-sizing: border-box; } /* –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å —à–∏—Ä–∏–Ω–æ–π */
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      padding-bottom: 90px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –Ω–∏–∂–Ω—é—é –ø–∞–Ω–µ–ª—å */
      margin: 0;
      background: #f2f2f2;
      color: #000;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden; /* –£–±–∏—Ä–∞–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    }

    body.dark {
      background: #1e1e1e;
      color: #ddd;
    }

    .hidden { display: none !important; }
    
    /* Colors & Thresholds */
    .text-normal { color: inherit; }
    .text-warn { color: #d35400; font-weight: bold; }
    .text-danger { color: #c0392b; font-weight: 900; animation: pulse 2s infinite; }
    body.dark .text-warn { color: #f39c12; }
    body.dark .text-danger { color: #e74c3c; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

    /* Top Bar */
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    h1 { margin: 0; font-size: 24px; white-space: nowrap; }
    #status { margin-bottom: 20px; font-size: 14px; color: #666; }
    body.dark #status { color: #aaa; }

    .controls { display: flex; gap: 8px; }
    .btn {
      cursor: pointer; font-size: 16px; background: #fff; border: 1px solid #ccc;
      padding: 6px 12px; border-radius: 6px; transition: 0.2s; display: inline-flex;
      align-items: center; justify-content: center;
    }
    .btn:hover { background-color: #e9e9e9; }
    .btn.active { background-color: #d4edda; border-color: #28a745; color: #155724; }
    body.dark .btn { background: #444; border-color: #666; color: #eee; }
    body.dark .btn:hover { background-color: #555; }
    body.dark .btn.active { background-color: #235d3a; border-color: #28a745; color: #fff; }

    /* Grid */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; width: 100%; }
    .card {
      background: white; border-radius: 12px; padding: 20px 22px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column;
      justify-content: space-between; transition: box-shadow 0.3s; min-height: 250px;
    }
    body.dark .card { background: #2e2e2e; color: #eee; }
    body.drag-enabled .card { cursor: grab; }
    body.drag-enabled .card:active { cursor: grabbing; }
    .card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    .card.dragging { opacity: 0.4; border: 2px dashed #999; }
    .queue-name { font-weight: bold; font-size: 18px; margin-bottom: 4px; pointer-events: none; }
    .queue-id { font-size: 13px; color: #565656; margin-bottom: 10px; pointer-events: none; }
    body.dark .queue-id { color: #dcdcdc; }
    .queue-count { font-size: 40px; font-weight: bold; margin-bottom: 10px; pointer-events: none; }
    .local-stats-block { font-size: 11px; color: #666; margin-top: 5px; padding-top: 5px; border-top: 1px solid #eee; display: flex; justify-content: space-between; }
    body.dark .local-stats-block { color: #aaa; border-color: #444; }

    /* List */
    .list-container { width: 100%; overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    body.dark .list-container { background: #2e2e2e; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th { text-align: left; padding: 12px 15px; border-bottom: 2px solid #ddd; font-size: 14px; color: #555; background-color: #f8f8f8; }
    body.dark th { border-color: #444; color: #aaa; background-color: #333; }
    td { padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 15px; }
    body.dark td { border-color: #444; }
    
    .queue-row { cursor: pointer; transition: background 0.1s; }
    .queue-row:hover { background-color: #f0f0f0; }
    body.dark .queue-row:hover { background-color: #383838; }
    
    .detail-row { display: none; background-color: #fafafa; }
    body.dark .detail-row { background-color: #252525; }
    .detail-row.open { display: table-row; }
    .detail-content { padding: 15px; max-height: 300px; overflow-y: auto; border-bottom: 1px solid #ddd; }
    .toggle-icon { display: inline-block; width: 20px; transition: transform 0.2s; color: #888; }
    .queue-row.expanded .toggle-icon { transform: rotate(90deg); }
    
    .badge { padding: 4px 10px; border-radius: 6px; font-weight: bold; font-size: 14px; }
    .bg-low { background: #d4edda; color: #155724; }
    .bg-med { background: #fff3cd; color: #5c4604; }
    .bg-high { background: #f8d7da; color: #721c24; }
    body.dark .bg-low { background: #235d3a; color: #ebffea; }
    body.dark .bg-med { background: #665700; color: #fff3cd; }
    body.dark .bg-high { background: #5b1f1f; color: #f8d7da; }

    /* Callers */
    .callers-list { font-size: 14px; line-height: 1.6; flex-grow: 1; margin: 6px 0 8px 0; }
    .caller-row { display: flex; align-items: center; margin-bottom: 5px; border-bottom: 1px dotted #eee; padding-bottom: 2px;}
    body.dark .caller-row { border-color: #444; }
    .caller-row:last-child { border-bottom: none; }
    .caller-index { margin-right: 8px; font-weight: bold; color: #888; min-width: 20px; }
    .caller-info { white-space: normal; overflow: visible; flex-grow: 1; margin: 0 5px; }
    .action-btn { cursor: pointer; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; transition: 0.2s; font-size: 16px; }
    .action-btn:hover { background-color: rgba(0,0,0,0.1); transform: scale(1.1); }
    body.dark .action-btn:hover { background-color: rgba(255,255,255,0.1); }
    .accept-btn { color: #28a745; margin-right: 4px; }
    .copy-btn { opacity: 0.6; } .copy-btn:hover { opacity: 1; }

    /* Tooltips */
    .stat-container { position: relative; display: inline-block; cursor: help; }
    .stat-tooltip {
        visibility: hidden; width: 110px; background-color: rgba(0,0,0,0.9); color: #fff; text-align: left;
        border-radius: 6px; padding: 8px; position: absolute; z-index: 9999;
        bottom: 125%; left: 50%; margin-left: -55px; opacity: 0; transition: opacity 0.3s;
        font-size: 11px; line-height: 1.4; pointer-events: none;
    }
    .stat-tooltip::after {
        content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
        border-width: 5px; border-style: solid; border-color: rgba(0,0,0,0.9) transparent transparent transparent;
    }
    .stat-container:hover .stat-tooltip { visibility: visible; opacity: 1; }

    /* GLOBAL BAR */
    .global-stats {
        position: fixed; bottom: 0; left: 0; right: 0; /* right:0 for full width */
        background: #2c3e50; color: white;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 2000; display: flex; justify-content: center;
        padding: 10px 0; gap: 30px; transition: transform 0.3s;
        width: 100%;
    }
    body.dark .global-stats { background: #252525; border-top: 1px solid #444; }
    .global-stats.minimized { transform: translateY(100%); }
    .stats-toggle-tab {
        position: absolute; top: -24px; right: 20px; background: #2c3e50; color: white;
        padding: 2px 15px; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 12px;
    }
    body.dark .stats-toggle-tab { background: #252525; border: 1px solid #444; border-bottom: none; }
    
    .g-stat-item { text-align: center; min-width: 100px; border-right: 1px solid rgba(255,255,255,0.1); padding-right: 20px; }
    .g-stat-item:last-child { border: none; }
    .g-stat-value { font-size: 20px; font-weight: bold; }
    .g-stat-label { font-size: 10px; opacity: 0.7; text-transform: uppercase; }
    .g-stat-sub { font-size: 11px; opacity: 0.8; }
    .top-count { color: #ff6b6b; font-weight: bold; margin-right: 5px; }

    /* Modals & Settings */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 3000; }
    .modal-content { background: white; padding: 20px; border-radius: 12px; width: 360px; max-height: 85vh; overflow-y: auto; }
    body.dark .modal-content { background: #2b2b2b; color: #eee; }
    .settings-group { margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
    body.dark .settings-group { border-color: #444; }
    .add-queue-form { display: flex; gap: 5px; margin-top: 5px; }
    .delete-q-btn { background: none; border: none; color: #ff4444; cursor: pointer; }
    
    /* Cheatsheet */
    .cheatsheet { margin-top: 30px; padding: 20px; background: white; display: flex; gap: 40px; margin-bottom: 100px; border-radius: 12px; flex-wrap: wrap;}
    body.dark .cheatsheet { background: #2e2e2e; color: #eee; }
  </style>
</head>
<body>

<div class="top-bar">
  <h1 style="margin:0">üìû –ê–∫—Ç–∏–≤–Ω—ñ —á–µ—Ä–≥–∏</h1>
  <div class="controls">
      <button class="btn active" id="viewGridBtn" onclick="switchView('grid')">üî≤</button>
      <button class="btn" id="viewListBtn" onclick="switchView('list')">‚ò∞</button>
      <button class="btn" id="dragBtn" onclick="toggleDragMode()">üîí</button>
      <button class="btn" onclick="openSettings()">‚öôÔ∏è</button>
  </div>
</div>

<div id="status" style="margin-bottom:20px; color:#666;">üîÑ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>

<div class="grid" id="queuesGrid"></div>

<div class="list-container hidden" id="queuesList">
  <table>
    <thead>
      <tr>
        <th style="width: 30%">Queue Name</th>
        <th style="width: 15%">Max Wait</th>
        <th style="width: 10%">Waiting</th>
        <th style="width: 20%">Agents</th>
        <th style="width: 25%">Daily Stats</th>
      </tr>
    </thead>
    <tbody id="listBody"></tbody>
  </table>
</div>

<div class="global-stats" id="statsBar">
    <div class="stats-toggle-tab" onclick="toggleStatsBar()" id="statsToggleIcon">‚ñº –°—Ö–æ–≤–∞—Ç–∏</div>
    
    <div class="g-stat-item">
        <span class="g-stat-label">Total Waiting</span>
        <span class="g-stat-value" id="gs-waiting">0</span>
    </div>
    
    <div class="g-stat-item">
        <span class="g-stat-label">üî• Top 3 Busy</span>
        <div id="gs-top3" style="font-size:12px; text-align:left;">
            <div style="opacity:0.5; margin-top:5px;">‚Äî No Calls ‚Äî</div>
        </div>
    </div>

    <div class="g-stat-item">
        <span class="g-stat-label">Max Wait</span>
        <span class="g-stat-value" id="gs-max-hold">00:00</span>
    </div>
    
    <div class="g-stat-item" style="min-width: 180px;">
        <span class="g-stat-label">Global Daily Stats</span>
        <div style="display: flex; justify-content: space-around;">
            <div class="stat-container">
                <div class="g-stat-value" id="gs-today-ans" style="color: #2ecc71;">0</div>
                <div class="g-stat-sub">Ans</div>
                <div class="stat-tooltip" id="tip-g-ans">Loading...</div>
            </div>
            <div class="stat-container">
                <div class="g-stat-value" id="gs-today-abd" style="color: #e74c3c;">0</div>
                <div class="g-stat-sub">Abd</div>
                <div class="stat-tooltip" id="tip-g-abd">Loading...</div>
            </div>
            <div class="stat-container">
                <div class="g-stat-value" id="gs-today-sl">0%</div>
                <div class="g-stat-sub">SL</div>
                <div class="stat-tooltip" id="tip-g-sl">Loading...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <form id="settingsForm"></form>
    <div class="modal-buttons">
      <button type="button" class="cancel-btn" onclick="closeSettings()">Close</button>
      <button type="button" class="save-btn" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<div class="cheatsheet">
  <div>
    <h3>üìå Prefixes</h3>
    <ul>
      <li>TrackEnsure Support: <strong>04</strong></li>
      <li>Alfa Support: <strong>06</strong></li>
      <li>Vista Support: <strong>09</strong></li>
      <li>Swift Support: <strong>08</strong></li>
      <li>KGZ: <strong>12</strong></li>
    </ul>
  </div>
</div>

<script>
  // üëáüëáüëá –í–ê–®–ê –°–°–´–õ–ö–ê –° RENDER
  const API_URL = "https://queue-server-fbi5.onrender.com/stats"; 

  let currentView = localStorage.getItem('viewMode') || 'grid';
  let isDragEnabled = false;
  
  const queueCallers = {}; 
  const queuesData = {};   
  const timers = {};       
  
  let fullStats = { daily: { queues: {} }, queuesPeriods: {}, globalPeriods: { h1:{}, h2:{}, h4:{} } };

  const statusEl = document.getElementById('status');
  const gridEl = document.getElementById('queuesGrid');
  const listBody = document.getElementById('listBody');
  const settingsModal = document.getElementById('settingsModal');
  const settingsForm = document.getElementById('settingsForm');
  const dragBtn = document.getElementById('dragBtn');

// --- FETCH STATS ---
  async function fetchGlobalStats() {
      try {
          const res = await fetch(API_URL);
          if (res.ok) {
              const data = await res.json();
              fullStats = data;
              
              // 1. –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
              updateGlobalSummary(); 
              
              // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö (Ans/Abd/SL)
              Object.keys(fullStats.daily.queues).forEach(qid => {
                  updateStatLabels('ls-', qid);
                  updateStatLabels('l-', qid);
              });

              // 3. –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–≤–æ–Ω—è—â–∏—Ö (–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ F5)
              if (data.activeCallers) {
                  Object.keys(data.activeCallers).forEach(qid => {
                      const serverList = data.activeCallers[qid] || [];
                      
                      // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –Ω–∞—à–µ–≥–æ UI
                      // –°–µ—Ä–≤–µ—Ä: { number, name, joinTime }
                      // UI –æ–∂–∏–¥–∞–µ—Ç: { number, name, lang } (lang –ø–∞—Ä—Å–∏–º —Ç—É—Ç)
                      
                      const uiList = serverList.map(c => {
                          const rawName = c.name;
                          const lang = detectLanguage(rawName);
                          const cleanName = detectName(rawName);
                          
                          let displayText = "‚Äî";
                          if (c.number && cleanName) displayText = `${c.number} (${cleanName})`;
                          else if (c.number) displayText = c.number;
                          else if (cleanName) displayText = cleanName;

                          return { number: c.number, name: displayText, lang: lang };
                      });

                      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ —Ä–∏—Å—É–µ–º
                      queueCallers[qid] = uiList;
                      updateCallersList(qid);
                  });
              }
          }
      } catch (e) { console.warn("Failed to fetch stats:", e); }
  }
  // –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É –∏ –ø–æ—Ç–æ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫ (—á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –∑–≤–æ–Ω—è—â–∏—Ö –±—ã–ª —Å–≤–µ–∂–∏–º —É –≤—Å–µ—Ö)
  setInterval(fetchGlobalStats, 5000); 
  fetchGlobalStats();

  // ... (–û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ...
  // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏-—Ö–µ–ª–ø–µ—Ä—ã –Ω–∏–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –≤–∞—à–µ–º –∫–æ–¥–µ (–æ–Ω–∏ —Ç–∞–º –±—ã–ª–∏):
  
  function detectLanguage(name) { 
      if (!name) return "?";
      const u = name.toUpperCase(); 
      if (u.includes("UKR")) return "ukr"; 
      if (u.includes("RU")) return "ru"; 
      if (u.includes("EN")) return "en"; 
      return "?"; 
  }
  
  function detectName(raw) { 
      if (!raw) return "";
      const idx = raw.lastIndexOf(":"); 
      return idx === -1 ? raw : raw.slice(idx + 1).trim(); 
  }

  function getQStats(qid) {
      if (!fullStats.daily.queues || !fullStats.daily.queues[qid]) return { ans: 0, abd: 0, sl_hits: 0 };
      return fullStats.daily.queues[qid];
  }

  // Generate Tooltip HTML
  function getTooltipHTML(type, qid) {
      const source = qid ? (fullStats.queuesPeriods[qid] || {}) : fullStats.globalPeriods;
      const h1 = source.h1 || { ans: 0, abd: 0, sl: 0 };
      const h2 = source.h2 || { ans: 0, abd: 0, sl: 0 };
      const h4 = source.h4 || { ans: 0, abd: 0, sl: 0 };
      const val = (obj) => type === 'sl' ? obj[type] + '%' : obj[type];
      return `1h: <b>${val(h1)}</b><br>2h: <b>${val(h2)}</b><br>4h: <b>${val(h4)}</b>`;
  }

  function updateStatLabels(prefix, qid) {
      const stats = getQStats(qid);
      const slPercent = stats.ans > 0 ? Math.round((stats.sl_hits / stats.ans) * 100) : 0;

      const elAns = document.getElementById(`${prefix}ans-${qid}`);
      const elAbd = document.getElementById(`${prefix}abd-${qid}`);
      const elSl = document.getElementById(`${prefix}sl-${qid}`);
      
      if(elAns) elAns.textContent = stats.ans;
      if(elAbd) elAbd.textContent = stats.abd;
      if(elSl) elSl.textContent = slPercent + '%';

      const tipAns = document.getElementById(`${prefix}tip-ans-${qid}`);
      const tipAbd = document.getElementById(`${prefix}tip-abd-${qid}`);
      const tipSl = document.getElementById(`${prefix}tip-sl-${qid}`);

      if(tipAns) tipAns.innerHTML = getTooltipHTML('ans', qid);
      if(tipAbd) tipAbd.innerHTML = getTooltipHTML('abd', qid);
      if(tipSl) tipSl.innerHTML = getTooltipHTML('sl', qid);
  }

  // UI Construction
  function createCard(qid, name, data) {
      const card = document.createElement('div');
      card.className = 'card'; card.id = `card-${qid}`; card.setAttribute('draggable', isDragEnabled);
      card.addEventListener('dragstart', handleDragStart); card.addEventListener('dragenter', handleDragEnter);
      card.addEventListener('dragover', handleDragOver); card.addEventListener('drop', handleDrop); card.addEventListener('dragend', handleDragEnd);

      const holdClass = getHoldColorClass(data.hold);
      
      card.innerHTML = `
        <div class="queue-name">${name}</div>
        <div class="queue-id">${qid}</div>
        <div class="queue-count" id="count-${qid}">${data.queued_calls}</div>
        <div class="callers-list" id="callers-${qid}"></div>
        <div class="local-stats-block">
            <div class="stat-container">
                <span>Ans: <b id="ls-ans-${qid}">0</b></span>
                <div class="stat-tooltip" id="ls-tip-ans-${qid}">...</div>
            </div>
            <div class="stat-container">
                <span>Abd: <b id="ls-abd-${qid}" style="color: #c0392b">0</b></span>
                <div class="stat-tooltip" id="ls-tip-abd-${qid}">...</div>
            </div>
            <div class="stat-container">
                <span>SL: <b id="ls-sl-${qid}">0%</b></span>
                <div class="stat-tooltip" id="ls-tip-sl-${qid}">...</div>
            </div>
        </div>
        <div class="queue-info-block" style="margin-top:5px;">
          üë• Logged: <span id="logged-${qid}">${data.logged_in}</span><br>
          ‚úÖ Avalible: <span id="avail-${qid}">${data.available}</span><br>
          ‚è≥ Waiting: <span id="hold-${qid}" class="${holdClass}">${formatTime(data.hold)}</span>
        </div>
      `;
      setTimeout(() => updateStatLabels('ls-', qid), 0);
      updateColorClass(card, data.queued_calls);
      return card;
  }

  function createListRow(qid, name, data) {
      const tr = document.createElement('tr'); tr.className = 'queue-row'; tr.id = `row-${qid}`; tr.onclick = () => toggleRow(qid);
      const holdClass = getHoldColorClass(data.hold);
      tr.innerHTML = `
        <td><span class="toggle-icon">‚ñ∂</span> <strong>${name}</strong> <span style="font-size:11px;color:#888;">${qid}</span></td>
        <td><span id="l-hold-${qid}" class="${holdClass}" style="font-weight:bold;">${formatTime(data.hold)}</span></td>
        <td><span class="badge" id="l-badge-${qid}">${data.queued_calls}</span></td>
        <td><span id="l-logged-${qid}">${data.logged_in}</span> / <span id="l-avail-${qid}">${data.available}</span></td>
        <td style="font-size:13px; color:#555; white-space: nowrap;">
            <div class="stat-container">
                SL: <span id="l-sl-${qid}" style="font-weight:bold">0%</span>
                <div class="stat-tooltip" id="l-tip-sl-${qid}">...</div>
            </div> | 
            <div class="stat-container">
                Abd: <span id="l-abd-${qid}" style="color:#c0392b; font-weight:bold;">0</span>
                <div class="stat-tooltip" id="l-tip-abd-${qid}">...</div>
            </div> | 
            <div class="stat-container">
                Ans: <span id="l-ans-${qid}" style="color:#27ae60; font-weight:bold;">0</span>
                <div class="stat-tooltip" id="l-tip-ans-${qid}">...</div>
            </div>
        </td>
      `;
      const detailTr = document.createElement('tr'); detailTr.className = 'detail-row'; detailTr.id = `detail-${qid}`;
      detailTr.innerHTML = `<td colspan="5" style="padding:0;"><div class="detail-content"><div class="callers-list" id="l-callers-${qid}"></div></div></td>`;
      setTimeout(() => updateStatLabels('l-', qid), 0);
      updateRowColor(tr, data.queued_calls);
      return { mainRow: tr, detailRow: detailTr };
  }

  function updateGlobalSummary() {
      const allQueueIds = Object.keys(getAllQueues());
      let totalWaiting = 0; let maxHold = 0; let busyList = [];
      allQueueIds.forEach(qid => {
          const d = queuesData[qid];
          if(d) {
              const calls = Number(d.queued_calls || 0);
              totalWaiting += calls;
              const h = Number(d.hold || 0);
              if(h > maxHold) maxHold = h;
              if(calls > 0) busyList.push({ name: getAllQueues()[qid] || qid, count: calls });
          }
      });

      document.getElementById('gs-waiting').textContent = totalWaiting;
      const mhEl = document.getElementById('gs-max-hold');
      mhEl.textContent = formatTime(maxHold);
      if(maxHold >= 600) mhEl.classList.add('alert'); else mhEl.classList.remove('alert');

      let totalAns = 0; let totalAbd = 0; let totalSLHits = 0;
      if (fullStats.daily.queues) {
          Object.values(fullStats.daily.queues).forEach(s => {
              totalAns += s.ans; totalAbd += s.abd; totalSLHits += s.sl_hits;
          });
      }
      const totalSlPercent = totalAns > 0 ? Math.round((totalSLHits / totalAns) * 100) : 0;
      document.getElementById('gs-today-ans').textContent = totalAns;
      document.getElementById('gs-today-abd').textContent = totalAbd;
      document.getElementById('gs-today-sl').textContent = totalSlPercent + '%';

      document.getElementById('tip-g-ans').innerHTML = getTooltipHTML('ans', null);
      document.getElementById('tip-g-abd').innerHTML = getTooltipHTML('abd', null);
      document.getElementById('tip-g-sl').innerHTML = getTooltipHTML('sl', null);

      const top3Container = document.getElementById('gs-top3');
      if (busyList.length === 0) {
          top3Container.innerHTML = '<div style="opacity:0.5; margin-top:5px;">‚Äî No Calls ‚Äî</div>';
      } else {
          busyList.sort((a, b) => b.count - a.count);
          top3Container.innerHTML = busyList.slice(0, 3).map(item => `<div style="margin-bottom:2px"><span style="color:#ff6b6b;font-weight:bold;margin-right:5px">${item.count}</span><span>${item.name}</span></div>`).join('');
      }
  }

  // --- STANDARD BOILERPLATE ---
  const defaultQueueNames = {
    Q700: "TrackEnsure Support", Q701: "TrackEnsure Support rus/ukr", Q801: "Callback rus/ukr", Q800: "Callback",
    Q791: "TrackEnsure New", Q750: "VIP Queue", Q702: "Fleet Supp", Q710: "Alfa Support",
    Q733: "Alfa VIP", Q720: "Vista Support", Q734: "Vista VIP", Q740: "Swift Support",
    Q760: "Swift VIP", Q766: "Sharp Support", Q745: "Club Support", Q781: "Pro-TracKing Support",
    Q730: "Smart eLog Support", Q777: "KGZ"
  };
  function getLang() { return localStorage.getItem('lang') || 'ua'; }
  function getTheme() { return localStorage.getItem('theme') || 'light'; }
  function getUserExt() { return localStorage.getItem('userExt') || ''; }
  function getCustomQueues() { return JSON.parse(localStorage.getItem('customQueues') || '{}'); }
  function getAllQueues() { return { ...defaultQueueNames, ...getCustomQueues() }; }
  function loadVisibleQueues() { return JSON.parse(localStorage.getItem('visibleQueues') || JSON.stringify(Object.keys(getAllQueues()))); }
  function saveVisibleQueues(list) { localStorage.setItem('visibleQueues', JSON.stringify(list)); }
  function formatTime(seconds) { const m = String(Math.floor(seconds / 60)).padStart(2, '0'); const s = String(seconds % 60).padStart(2, '0'); return `${m}:${s}`; }
  
  function switchView(mode) {
      currentView = mode; localStorage.setItem('viewMode', mode);
      const gridBtn = document.getElementById('viewGridBtn'); const listBtn = document.getElementById('viewListBtn');
      if (mode === 'grid') { gridEl.classList.remove('hidden'); document.getElementById('queuesList').classList.add('hidden'); gridBtn.classList.add('active'); listBtn.classList.remove('active'); dragBtn.style.display = 'inline-flex'; }
      else { gridEl.classList.add('hidden'); document.getElementById('queuesList').classList.remove('hidden'); gridBtn.classList.remove('active'); listBtn.classList.add('active'); dragBtn.style.display = 'none'; isDragEnabled = false; updateDragUI(); }
      renderAll();
  }
  function toggleDragMode() { isDragEnabled = !isDragEnabled; updateDragUI(); }
  function updateDragUI() { dragBtn.textContent = isDragEnabled ? "‚úã" : "üîí"; dragBtn.classList.toggle("active", isDragEnabled); document.body.classList.toggle("drag-enabled", isDragEnabled); document.querySelectorAll('.card').forEach(c => c.setAttribute('draggable', isDragEnabled)); }
  function toggleStatsBar() { const bar = document.getElementById('statsBar'); const btn = document.getElementById('statsToggleIcon'); bar.classList.toggle('minimized'); if (bar.classList.contains('minimized')) { btn.textContent = '‚ñ≤ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'; localStorage.setItem('statsBarMinimized', 'true'); } else { btn.textContent = '‚ñº –°—Ö–æ–≤–∞—Ç–∏'; localStorage.setItem('statsBarMinimized', 'false'); }}
  if (localStorage.getItem('statsBarMinimized') === 'true') { document.getElementById('statsBar').classList.add('minimized'); document.getElementById('statsToggleIcon').textContent = '‚ñ≤ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'; }
  function getHoldColorClass(seconds) { if (seconds >= 600) return 'text-danger'; if (seconds >= 300) return 'text-warn'; return 'text-normal'; }
  function toggleRow(qid) { const row = document.getElementById(`row-${qid}`); const detail = document.getElementById(`detail-${qid}`); if(row && detail) { row.classList.toggle('expanded'); detail.classList.toggle('open'); }}
  function updateColorClass(el, count) { el.classList.remove('queue-low', 'queue-medium', 'queue-high'); const num = Number(count); if (num >= 5) el.classList.add('queue-high'); else if (num >= 3) el.classList.add('queue-medium'); else if (num >= 1) el.classList.add('queue-low'); }
  function updateRowColor(row, count) { const badge = row.querySelector('.badge'); if(badge) { badge.className = 'badge'; const num = Number(count); if (num >= 5) badge.classList.add('bg-high'); else if (num >= 3) badge.classList.add('bg-med'); else if (num >= 1) badge.classList.add('bg-low'); } }
  function copyText(text, btnElement) { if (!text) return; navigator.clipboard.writeText(text).then(() => { const original = btnElement.textContent; btnElement.textContent = "‚úÖ"; setTimeout(() => btnElement.textContent = original, 1500); }); }
  function acceptCall(callerNumber) { if (!callerNumber) return; const userExt = getUserExt(); if (!userExt) { alert("Extension required!"); openSettings(); return; } window.postMessage({ type: "CONNECT_CALL", userExtension: userExt, targetNumber: callerNumber, source: "queue_monitor" }, "*"); }

  function updateQueueData(qid, raw) {
      queuesData[qid] = { queued_calls: Number(raw.queued_calls), logged_in: raw.logged_in_members, available: raw.available_members, hold: Number(raw.longest_hold_time || 0) };
      const d = queuesData[qid];
      const card = document.getElementById(`card-${qid}`);
      if (card) {
          document.getElementById(`count-${qid}`).textContent = d.queued_calls;
          document.getElementById(`logged-${qid}`).textContent = d.logged_in;
          document.getElementById(`avail-${qid}`).textContent = d.available;
          updateColorClass(card, d.queued_calls);
          updateStatLabels('ls-', qid);
      }
      const row = document.getElementById(`row-${qid}`);
      if (row) {
          document.getElementById(`l-badge-${qid}`).textContent = d.queued_calls;
          document.getElementById(`l-logged-${qid}`).textContent = d.logged_in;
          document.getElementById(`l-avail-${qid}`).textContent = d.available;
          updateRowColor(row, d.queued_calls);
          updateStatLabels('l-', qid);
      }
      handleTimer(qid, d.hold, d.queued_calls); updateGlobalSummary();
      if (d.queued_calls === 0) { queueCallers[qid] = []; updateCallersList(qid); }
      else if (queueCallers[qid] && queueCallers[qid].length > d.queued_calls) { queueCallers[qid] = queueCallers[qid].slice(0, d.queued_calls); updateCallersList(qid); }
  }

  function handleTimer(qid, startSeconds, count) {
      if (timers[qid]) clearInterval(timers[qid]); let hold = startSeconds;
      const render = (val) => {
          const fmt = formatTime(val); const colorClass = getHoldColorClass(val);
          const gh = document.getElementById(`hold-${qid}`); if(gh) { gh.textContent=fmt; gh.className=colorClass; }
          const lh = document.getElementById(`l-hold-${qid}`); if(lh) { lh.textContent=fmt; lh.className=colorClass; }
      };
      render(hold);
      if (count > 0) timers[qid] = setInterval(() => { hold++; render(hold); updateGlobalSummary(); }, 1000);
  }

  function updateCallersList(qid) {
      const callers = queueCallers[qid] || [];
      const generateHTML = (list) => {
          if (!list.length) return '<div style="color:#999;font-style:italic;">No active callers</div>';
          return list.map((c, i) => {
              const acceptBtn = c.number ? `<span class="action-btn accept-btn" onclick="event.stopPropagation(); acceptCall('${c.number}')">üìû</span>` : '';
              const copyBtn = c.number ? `<span class="action-btn copy-btn" onclick="event.stopPropagation(); copyText('${c.number}', this)">üìã</span>` : '';
              return `<div class="caller-row"><span class="caller-index">${i + 1}.</span>${acceptBtn}<span class="caller-info">üåê ${c.lang.toUpperCase()} ‚Äî ${c.name}</span>${copyBtn}</div>`;
          }).join('');
      };
      const gl = document.getElementById(`callers-${qid}`); if(gl) gl.innerHTML = generateHTML(callers.slice(0, 5));
      const ll = document.getElementById(`l-callers-${qid}`); if(ll) ll.innerHTML = generateHTML(callers);
  }

  function connectWebSocket() {
    statusEl.textContent = "üîÑ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...";
    const socket = new WebSocket("wss://trackensure.gitstel.net/sw-monitor/?EIO=3&transport=websocket");
    socket.onopen = () => { statusEl.textContent = "‚úÖ –ó'—î–¥–Ω–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"; };
    function detectLanguage(name) { const u = name.toUpperCase(); if (u.includes("UKR")) return "ukr"; if (u.includes("RU")) return "ru"; if (u.includes("EN")) return "en"; return "?"; }
    function detectName(raw) { const idx = raw.lastIndexOf(":"); return idx === -1 ? raw : raw.slice(idx + 1).trim(); }

    socket.onmessage = (event) => {
      const data = event.data;
      if (data.startsWith('42')) {
        try {
          const payload = JSON.parse(data.slice(2));
          const type = payload[0];
          const d = payload[1];
          if (type === 'queue_times') updateQueueData(d.queue, d);
          if (type === 'queue_caller_join') {
            const { queue, position } = d;
            if (queue && position) {
                const number = d.connectedlinenum || d.calleridnum || d.caller_number || "";
                const rawName = d.connectedlinename || d.calleridname || d.caller_name || "";
                const cleanName = detectName(rawName);
                const lang = detectLanguage(rawName);
                let displayText = "‚Äî";
                if (number && cleanName) displayText = `${number} (${cleanName})`; else if (number) displayText = number; else if (cleanName) displayText = cleanName;
                if (!queueCallers[queue]) queueCallers[queue] = [];
                if (number) queueCallers[queue] = queueCallers[queue].filter(c => c.number !== number);
                const idx = Math.max(Number(position) - 1, 0);
                queueCallers[queue].splice(idx, 0, { name: displayText, number, lang });
                updateCallersList(queue);
            }
          }
          if (type === 'queue_caller_leave' || type === 'queue_caller_abandon') {
             const { queue, position } = d;
             if (queue && queueCallers[queue]) {
                if (position) { const idx = Number(position) - 1; if (idx >= 0) queueCallers[queue].splice(idx, 1); }
                else queueCallers[queue].shift();
                updateCallersList(queue);
             }
          }
        } catch (err) {}
      }
    };
    socket.onclose = () => { statusEl.textContent = "üîå –ó'—î–¥–Ω–∞–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ..."; setTimeout(connectWebSocket, 5000); };
  }

  // --- SETTINGS (Simplified) ---
  function openSettings() {
    settingsForm.innerHTML = `
      <div class="settings-group"><strong>–í–∞—à Extension:</strong><input type="text" name="userExt" value="${getUserExt()}" placeholder="101"></div>
      <div class="settings-group"><strong>–î–æ–¥–∞—Ç–∏ —á–µ—Ä–≥—É:</strong><div class="add-queue-form"><input type="text" id="newQId" placeholder="ID (Q...)"><input type="text" id="newQName" placeholder="Name"><button type="button" onclick="handleAddClick()">Add</button></div></div>
      <div class="settings-group"><strong>–í–∏–¥–∏–º—ñ —á–µ—Ä–≥–∏:</strong><div id="qList"></div></div>
      <div class="settings-group"><strong>Theme:</strong> <label><input type="radio" name="theme" value="light" ${getTheme()==='light'?'checked':''}> Light</label> <label><input type="radio" name="theme" value="dark" ${getTheme()==='dark'?'checked':''}> Dark</label></div>
    `;
    const qList = document.getElementById('qList');
    const visible = loadVisibleQueues(); const custom = getCustomQueues();
    Object.entries(getAllQueues()).forEach(([qid, name]) => {
      const isCustom = custom.hasOwnProperty(qid);
      const delBtn = isCustom ? `<button class="delete-q-btn" onclick="event.preventDefault(); removeCustomQueue('${qid}')">üóëÔ∏è</button>` : '';
      const div = document.createElement('div');
      div.innerHTML = `<label><span><input type="checkbox" name="queues" value="${qid}" ${visible.includes(qid) ? 'checked' : ''}> ${qid} - ${name} ${isCustom?'(Custom)':''}</span>${delBtn}</label>`;
      qList.appendChild(div);
    });
    settingsModal.style.display = 'flex';
  }
  function handleAddClick() { const id = document.getElementById('newQId').value; const name = document.getElementById('newQName').value; if(id && name) { const c = getCustomQueues(); c[id]=name; localStorage.setItem('customQueues', JSON.stringify(c)); openSettings(); }}
  function removeCustomQueue(id) { const c = getCustomQueues(); delete c[id]; localStorage.setItem('customQueues', JSON.stringify(c)); openSettings(); }
  function closeSettings() { settingsModal.style.display = 'none'; }
  function saveSettings() {
      const fd = new FormData(settingsForm);
      const sel = fd.getAll('queues');
      let order = loadVisibleQueues().filter(id => sel.includes(id));
      sel.forEach(id => { if(!order.includes(id)) order.push(id); });
      saveVisibleQueues(order);
      localStorage.setItem('theme', fd.get('theme')); localStorage.setItem('userExt', fd.get('userExt'));
      document.body.className = fd.get('theme');
      renderAll(); closeSettings();
  }

  // Init
  document.body.className = getTheme();
  switchView(currentView);
  connectWebSocket();
</script>
</body>
</html>
